<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:Coftea_Capstone.Views.Controls"
             xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
             xmlns:heightConv="clr-namespace:Coftea_Capstone.ViewModel.Others"
             x:Class="Coftea_Capstone.Views.Controls.InputIngredientsAmountUsed"
             x:Name="Root"
             BackgroundColor="#80000000"
             IsVisible="{Binding IsInputIngredientsVisible}">

    <!-- âœ… ResourceDictionary properly declared -->
    <ContentView.Resources>
        <ResourceDictionary>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter" />
            <heightConv:SelectedCountToHeightConverter x:Key="SelectedCountToHeightConverter"
                                                       CompactHeight="240"
                                                       ExpandedHeight="480" />
        </ResourceDictionary>
    </ContentView.Resources>

    <ScrollView>
        <Grid HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand">

            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="20">

                <HorizontalStackLayout Spacing="20">

                    <!-- Left: Inputs -->
                    <Frame BackgroundColor="#D8C4B6"
                           CornerRadius="24"
                           HasShadow="True"
                           WidthRequest="1000"
                           HeightRequest="700"
                           Padding="30"
                           IsVisible="{Binding IsPreviewVisible, Converter={StaticResource InvertBoolConverter}}">

                        <Grid RowDefinitions="*,Auto">

                            <!-- Scrollable content -->
                            <ScrollView Grid.Row="0">
                                <VerticalStackLayout Spacing="24">

                                    <!-- Size header -->
                                    <Label Text="Select Size"
                                           FontAttributes="Bold"
                                           FontSize="28"
                                           TextColor="#4A3F35"
                                           HorizontalOptions="Center"/>

                                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="16">
                                        <Button Text="Small"
                                                StyleClass="SizeButton"
                                                Command="{Binding SetSizeCommand}"
                                                CommandParameter="Small"/>
                                        <Button Text="Medium"
                                                StyleClass="SizeButton"
                                                Command="{Binding SetSizeCommand}"
                                                CommandParameter="Medium"/>
                                        <Button Text="Large"
                                                StyleClass="SizeButton"
                                                Command="{Binding SetSizeCommand}"
                                                CommandParameter="Large"/>
                                    </HorizontalStackLayout>

                                    <!-- Ingredient Table -->
                                    <VerticalStackLayout IsVisible="{Binding HasSelectedIngredients}" Spacing="20">

                                        <Label Text="Ingredients Used per Serving"
                                               FontAttributes="Bold"
                                               FontSize="22"
                                               TextColor="#4A3F35"
                                               HorizontalOptions="Center"/>

                                        <CollectionView ItemsSource="{Binding SelectedInventoryItems}" HeightRequest="480">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Frame BackgroundColor="#FAFAFA"
                                                           CornerRadius="16"
                                                           BorderColor="#EEE"
                                                           HasShadow="False"
                                                           Margin="0,6">

                                                        <Grid RowDefinitions="Auto,Auto"
                                                              ColumnDefinitions="2*,1.5*,1.5*,1*,1*"
                                                              Padding="16"
                                                              ColumnSpacing="20">

                                                            <!-- Item name -->
                                                            <Label Grid.Row="0"
                                                                   Grid.ColumnSpan="5"
                                                                   Text="{Binding itemName}"
                                                                   FontAttributes="Bold"
                                                                   FontSize="18"
                                                                   TextColor="#333"/>

                                                            <!-- Amount -->
                                                            <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="6">
                                                                <Label Text="Amount" FontSize="12" TextColor="#666"/>
                                                                <!-- Small -->
                                                                <Entry Placeholder="0"
                                                                       Keyboard="Numeric"
                                                                       WidthRequest="180"
                                                                       Text="{Binding InputAmountSmall}"
                                                                       IsVisible="False"
                                                                       BackgroundColor="#FFF">
                                                                    <Entry.Triggers>
                                                                        <DataTrigger TargetType="Entry"
                                                                                     Binding="{Binding Source={x:Reference Root}, Path=BindingContext.SelectedSize}"
                                                                                     Value="Small">
                                                                            <Setter Property="IsVisible" Value="True"/>
                                                                        </DataTrigger>
                                                                    </Entry.Triggers>
                                                                </Entry>
                                                            </VerticalStackLayout>

                                                            <!-- Unit -->
                                                            <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="6">
                                                                <Label Text="Unit" FontSize="12" TextColor="#666"/>
                                                                <Picker WidthRequest="140"
                                                                        ItemsSource="{Binding AllowedUnits}"
                                                                        SelectedItem="{Binding InputUnitSmall}"
                                                                        IsVisible="False">
                                                                    <Picker.Triggers>
                                                                        <DataTrigger TargetType="Picker"
                                                                                     Binding="{Binding Source={x:Reference Root}, Path=BindingContext.SelectedSize}"
                                                                                     Value="Small">
                                                                            <Setter Property="IsVisible" Value="True"/>
                                                                        </DataTrigger>
                                                                    </Picker.Triggers>
                                                                </Picker>
                                                            </VerticalStackLayout>

                                                            <!-- Price -->
                                                            <VerticalStackLayout Grid.Row="1" Grid.Column="2" Spacing="6" IsVisible="False">
                                                                <VerticalStackLayout.Triggers>
                                                                    <DataTrigger TargetType="VerticalStackLayout"
                                                                                 Binding="{Binding itemCategory}"
                                                                                 Value="Addons">
                                                                        <Setter Property="IsVisible" Value="True"/>
                                                                    </DataTrigger>
                                                                </VerticalStackLayout.Triggers>
                                                                <Label Text="Price Used" FontSize="12" TextColor="#666"/>
                                                                <HorizontalStackLayout IsVisible="False" Spacing="4">
                                                                    <Label Text="â‚±"/>
                                                                    <Entry Placeholder="0.00"
                                                                           Keyboard="Numeric"
                                                                           WidthRequest="120"
                                                                           Text="{Binding PriceUsedSmall}">
                                                                        <Entry.Triggers>
                                                                            <DataTrigger TargetType="Entry"
                                                                                         Binding="{Binding Source={x:Reference Root}, Path=BindingContext.SelectedSize}"
                                                                                         Value="Small">
                                                                                <Setter Property="IsVisible" Value="True"/>
                                                                            </DataTrigger>
                                                                        </Entry.Triggers>
                                                                    </Entry>
                                                                </HorizontalStackLayout>
                                                            </VerticalStackLayout>

                                                            <!-- Stock -->
                                                            <VerticalStackLayout Grid.Row="1" Grid.Column="3" Spacing="4">
                                                                <Label Text="Available" FontSize="12" TextColor="#666"/>
                                                                <Label Text="{Binding StockDisplay}" FontSize="14" TextColor="#222"/>
                                                            </VerticalStackLayout>

                                                            <!-- Min -->
                                                            <VerticalStackLayout Grid.Row="1" Grid.Column="4" Spacing="4">
                                                                <Label Text="Min" FontSize="12" TextColor="#666"/>
                                                                <Label Text="{Binding MinimumDisplay}" FontSize="14" TextColor="#222"/>
                                                            </VerticalStackLayout>

                                                        </Grid>
                                                    </Frame>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </VerticalStackLayout>

                                    <!-- Empty state -->
                                    <VerticalStackLayout IsVisible="{Binding HasSelectedIngredients, Converter={StaticResource InvertBoolConverter}}" Padding="20" Spacing="8">
                                        <Label Text="No ingredients selected." FontAttributes="Bold" HorizontalOptions="Center"/>
                                        <Label Text="Please go back and select items from inventory." HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </ScrollView>

                            <!-- Footer buttons -->
                            <HorizontalStackLayout Grid.Row="1" HorizontalOptions="End" Spacing="12" Margin="0,12,0,0">
                                <Button Text="Back"
                                        BackgroundColor="#F2F2F2"
                                        TextColor="Black"
                                        CornerRadius="12"
                                        WidthRequest="120"
                                        Command="{Binding BackToInventorySelectionCommand}"/>
                                <Button Text="Preview"
                                        BackgroundColor="#FFB347"
                                        TextColor="White"
                                        CornerRadius="12"
                                        WidthRequest="120"
                                        Command="{Binding ShowPreviewCommand}"/>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>

                    <!-- Right: Preview panel -->
                    <controls:PreviewPOSItem />
                </HorizontalStackLayout>
            </VerticalStackLayout>

            <!-- Addons Popup -->
            <controls:AddonSelectionPopup />
        </Grid>
    </ScrollView>
</ContentView>
