<?xml version="1.0" encoding="utf-8" ?>
<ContentView 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.HistoryPopup"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    x:Name="HistoryPopupView"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsHistoryVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:FilterButtonConverter x:Key="FilterButtonConverter"/>
            
            <!-- Shared style for filter buttons -->
            <Style x:Key="FilterButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="LightGray" />
                <Setter Property="TextColor" Value="Black" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontFamily" Value="MontserratBlack" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal">
                                <VisualState.Setters>
                                    <Setter Property="Scale" Value="1" />
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Pressed">
                                <VisualState.Setters>
                                    <Setter Property="Scale" Value="0.95" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <!-- Background overlay that closes on tap -->
        <BoxView BackgroundColor="#80000000" InputTransparent="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseHistoryCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Main Frame -->
        <Frame VerticalOptions="Center"
               HorizontalOptions="Center"
               Padding="0"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               WidthRequest="900"
               HeightRequest="700"
               HasShadow="True"
               InputTransparent="False">

            <Grid RowDefinitions="Auto, Auto, *">
                <!-- Header -->
                <Grid Grid.Row="0" BackgroundColor="#5B4F45" Padding="20,15">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0" 
                               Text="Transaction History" 
                               FontSize="24" FontFamily="MontserratBlack" 
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="White" />
                        <Button Grid.Column="1"
                                Text="Ã—"
                                Padding="0"
                                FontSize="24" FontFamily="MontserratBlack"
                                FontAttributes="Bold"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                WidthRequest="40"
                                HeightRequest="40"
                                VerticalOptions="Center"
                                Command="{Binding CloseHistoryCommand}" />
                    </Grid>
                </Grid>

                <!-- Filter Buttons -->
                <ScrollView Grid.Row="1" Orientation="Horizontal" Padding="20,25,20,5" HorizontalOptions="Center">
                    <HorizontalStackLayout Spacing="10">
                        <!-- Filter Buttons Template -->
                        <Button Text="Today" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="Today" WidthRequest="100" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Today}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="Yesterday" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="Yesterday" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Yesterday}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="3 Days Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="3 Days Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='3 Days Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="1 Week Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="1 Week Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='1 Week Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="2 Weeks Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="2 Weeks Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='2 Weeks Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="1 Month Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="1 Month Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='1 Month Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="All Time" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="All Time" WidthRequest="100" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='All Time'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                    </HorizontalStackLayout>
                </ScrollView>

                <!-- Transaction Table -->
                <Frame Grid.Row="2"
                       Margin="20,0,20,20"
                       Padding="0"
                       CornerRadius="15"
                       BackgroundColor="White"
                       HasShadow="False">
                        <Grid RowDefinitions="Auto, *">
                        <!-- Header -->
                        <Grid Grid.Row="0" BackgroundColor="#D6BCA8" Padding="15,10">
                            <Grid ColumnDefinitions="40,*,50,60,70,60,60,60,60,80,100,100">
                                <Label Grid.Column="0" Text="ID" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="1" Text="Drink Name" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black"/>
                                <Label Grid.Column="2" Text="Qty" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="3" Text="Size" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="4" Text="Add On" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="5" Text="Price" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="6" Text="Small" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="7" Text="Medium" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="8" Text="Large" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="9" Text="Addon" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="10" Text="Total" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                <Label Grid.Column="11" Text="Date" FontAttributes="Bold" FontSize="14" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                            </Grid>
                        </Grid>

                        <!-- Scrollable Data -->
                        <ScrollView Grid.Row="1">
                            <CollectionView ItemsSource="{Binding FilteredTransactions}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="15,8" Margin="0,0,0,1" BackgroundColor="#F9F9F9">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="40"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="70"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="100"/>
                                                <ColumnDefinition Width="100"/>
                                            </Grid.ColumnDefinitions>

                                            <Label Grid.Column="0" Text="{Binding TransactionId}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="1" Text="{Binding DrinkName}" FontSize="12" FontFamily="MontserratBlack" TextColor="Black"/>
                                            <Label Grid.Column="2" Text="{Binding Quantity}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="3" Text="{Binding Size}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="4" Text="{Binding AddOns}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="5" Text="{Binding FormattedPrice}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="6" Text="{Binding FormattedSmallPrice}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="7" Text="{Binding FormattedMediumPrice}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="8" Text="{Binding FormattedLargePrice}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="9" Text="{Binding FormattedAddonPrice}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="10" Text="{Binding FormattedTotal}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                            <Label Grid.Column="11" Text="{Binding FormattedDate}" FontSize="12" FontFamily="MontserratBlack" HorizontalOptions="Center" TextColor="Black"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </ScrollView>
                    </Grid>
                </Frame>
            </Grid>
        </Frame>
    </Grid>
</ContentView>
