<?xml version="1.0" encoding="utf-8" ?>
<ContentView 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.HistoryPopup"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    x:Name="HistoryPopupView"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsHistoryVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:FilterButtonConverter x:Key="FilterButtonConverter"/>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding CloseHistoryCommand}" />
        </Grid.GestureRecognizers>
        
        <!-- History Frame -->
        <Frame VerticalOptions="Center"
               HorizontalOptions="Center"
               Padding="0"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               WidthRequest="900"
               HeightRequest="700"
               HasShadow="True"
               InputTransparent="False">

            <Grid RowDefinitions="Auto, Auto, *, Auto">
                <!-- Header -->
                <Grid Grid.Row="0" BackgroundColor="#5B4F45" Padding="20,15">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0" 
                               Text="Transaction History" 
                               FontSize="24" 
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="White" />
                        <Button Grid.Column="1"
                                Text="Ã—"
                                FontSize="24"
                                FontAttributes="Bold"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                WidthRequest="40"
                                HeightRequest="40"
                                VerticalOptions="Center"
                                Command="{Binding CloseHistoryCommand}" />
                    </Grid>
                </Grid>

                <!-- Filter Buttons -->
                <ScrollView Grid.Row="1" Orientation="Horizontal" Padding="20,25,15,5" HorizontalOptions="Center" >
                    <HorizontalStackLayout Spacing="10">
                        <Button Text="Today" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="Today"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Today}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="Yesterday" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="Yesterday"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Yesterday}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="3 Days Ago" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="3 Days Ago"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=3 Days Ago}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="1 Week Ago" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="1 Week Ago"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=1 Week Ago}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="2 Weeks Ago" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="2 Weeks Ago"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=2 Weeks Ago}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="1 Month Ago" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="1 Month Ago"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=1 Month Ago}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Text="All Time" 
                                Command="{Binding FilterByTimePeriodCommand}" 
                                CommandParameter="All Time"
                                FontAttributes="Bold" 
                                FontFamily="Roboto" 
                                FontSize="14" 
                                WidthRequest="100" 
                                HeightRequest="40">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="LightGray" />
                                    <Setter Property="TextColor" Value="Black" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=All Time}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#5B4F45" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </HorizontalStackLayout>
                </ScrollView>

                <!-- Transaction History Table -->
                <Grid Grid.Row="2" Padding="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <!-- Fixed Table Header -->
                    <Grid Grid.Row="0" BackgroundColor="#D6BCA8" Padding="15,10" Margin="0,0,0,0">
                        <Grid ColumnDefinitions="40, *, 50, 60, 80, 80, 60, 80, 60">
                            <Label Grid.Column="0" Text="ID" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="40" HorizontalOptions="Center"/>
                            <Label Grid.Column="1" Text="Drink Name" FontAttributes="Bold" FontSize="14" TextColor="Black" HorizontalOptions="Start"/>
                            <Label Grid.Column="2" Text="Qty" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="50" HorizontalOptions="Center"/>
                            <Label Grid.Column="3" Text="Size" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="60" HorizontalOptions="Center"/>
                            <Label Grid.Column="4" Text="Add On" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="80" HorizontalOptions="Center"/>
                            <Label Grid.Column="5" Text="Price" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="80" HorizontalOptions="Center"/>
                            <Label Grid.Column="6" Text="VAT" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="60" HorizontalOptions="Center"/>
                            <Label Grid.Column="7" Text="Total" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="80" HorizontalOptions="Center"/>
                            <Label Grid.Column="8" Text="Date" FontAttributes="Bold" FontSize="14" TextColor="Black" WidthRequest="60" HorizontalOptions="Center"/>
                        </Grid>
                    </Grid>

                    <!-- Scrollable Transaction Data -->
                    <ScrollView Grid.Row="1" Padding="15,0">
                        <CollectionView ItemsSource="{Binding FilteredTransactions}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid BackgroundColor="White" Padding="15,8" Margin="0,0,0,1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="50" />
                                            <ColumnDefinition Width="60" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="60" />
                                            <ColumnDefinition Width="80" />
                                            <ColumnDefinition Width="60" />
                                        </Grid.ColumnDefinitions>

                                        <!-- ID -->
                                        <Label Grid.Column="0" 
                                               Text="{Binding TransactionId}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Drink Name -->
                                        <Label Grid.Column="1" 
                                               Text="{Binding DrinkName}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Start" />

                                        <!-- Quantity -->
                                        <Label Grid.Column="2" 
                                               Text="{Binding Quantity}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Size -->
                                        <Label Grid.Column="3" 
                                               Text="{Binding Size}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Add Ons -->
                                        <Label Grid.Column="4" 
                                               Text="{Binding AddOns}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Price -->
                                        <Label Grid.Column="5" 
                                               Text="{Binding FormattedPrice}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- VAT -->
                                        <Label Grid.Column="6" 
                                               Text="{Binding FormattedVAT}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Total -->
                                        <Label Grid.Column="7" 
                                               Text="{Binding FormattedTotal}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />

                                        <!-- Date -->
                                        <Label Grid.Column="8" 
                                               Text="{Binding FormattedDate}" 
                                               FontSize="12" 
                                               TextColor="Black" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>
                </Grid>

                <!-- Footer with Pagination and Actions -->
                <Grid Grid.Row="3" BackgroundColor="#E8D5C4" Padding="20,15">
                    <Grid ColumnDefinitions="*, Auto">
                        <!-- Pagination -->
                        <HorizontalStackLayout Grid.Column="0" Spacing="5" VerticalOptions="Center">
                            <Button Text="1" 
                                    Command="{Binding GoToPageCommand}" 
                                    CommandParameter="1"
                                    FontSize="14" 
                                    BackgroundColor="#5B4F45" 
                                    TextColor="White" 
                                    WidthRequest="30" 
                                    HeightRequest="30" 
                                    CornerRadius="15" />
                            <Button Text="2" 
                                    Command="{Binding GoToPageCommand}" 
                                    CommandParameter="2"
                                    FontSize="14" 
                                    BackgroundColor="LightGray" 
                                    TextColor="Black" 
                                    WidthRequest="30" 
                                    HeightRequest="30" 
                                    CornerRadius="15" />
                            <Button Text="3" 
                                    Command="{Binding GoToPageCommand}" 
                                    CommandParameter="3"
                                    FontSize="14" 
                                    BackgroundColor="LightGray" 
                                    TextColor="Black" 
                                    WidthRequest="30" 
                                    HeightRequest="30" 
                                    CornerRadius="15" />
                            <Button Text="4" 
                                    Command="{Binding GoToPageCommand}" 
                                    CommandParameter="4"
                                    FontSize="14" 
                                    BackgroundColor="LightGray" 
                                    TextColor="Black" 
                                    WidthRequest="30" 
                                    HeightRequest="30" 
                                    CornerRadius="15" />
                            <Button Text="5" 
                                    Command="{Binding GoToPageCommand}" 
                                    CommandParameter="5"
                                    FontSize="14" 
                                    BackgroundColor="LightGray" 
                                    TextColor="Black" 
                                    WidthRequest="30" 
                                    HeightRequest="30" 
                                    CornerRadius="15" />
                        </HorizontalStackLayout>

                        <!-- Action Buttons -->
                        <HorizontalStackLayout Grid.Column="1" Spacing="10" VerticalOptions="Center">
                            <Button Text="Refresh" 
                                    Command="{Binding RefreshHistoryCommand}" 
                                    BackgroundColor="#5B4F45"
                                    Padding="0"
                                    TextColor="White" 
                                    CornerRadius="15" 
                                    WidthRequest="80" 
                                    HeightRequest="35" />
                            <Button Text="Export" 
                                    Command="{Binding ExportHistoryCommand}" 
                                    BackgroundColor="#A57C5C" 
                                    Padding="0"
                                    TextColor="White" 
                                    CornerRadius="15" 
                                    WidthRequest="80" 
                                    HeightRequest="35" />
                        </HorizontalStackLayout>
                    </Grid>
                </Grid>
            </Grid>
        </Frame>
    </Grid>
</ContentView>
