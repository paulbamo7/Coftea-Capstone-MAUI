<?xml version="1.0" encoding="utf-8" ?>
<ContentView 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.HistoryPopup"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    x:Name="HistoryPopupView"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsHistoryVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:FilterButtonConverter x:Key="FilterButtonConverter"/>
            
            <!-- Shared style for filter buttons -->
            <Style x:Key="FilterButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="TextColor" Value="#2E7D32" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontFamily" Value="MontserratBlack" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="HeightRequest" Value="36" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="BorderColor" Value="#C8E6C9" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="Padding" Value="12,6" />
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal">
                                <VisualState.Setters>
                                    <Setter Property="Scale" Value="1" />
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Pressed">
                                <VisualState.Setters>
                                    <Setter Property="Scale" Value="0.95" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <!-- Background overlay that closes on tap -->
        <BoxView BackgroundColor="#80000000" InputTransparent="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseHistoryCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Date Filter Popup -->
        <Frame IsVisible="{Binding IsDateFilterVisible}"
               BackgroundColor="White"
               CornerRadius="15"
               Padding="20"
               WidthRequest="350"
               HeightRequest="450"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               HasShadow="True"
               InputTransparent="False"
               ZIndex="4000">
            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="15">
                <!-- Header -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                    <Label Text="ðŸ“… Filter by Date Range" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#5B4F45"
                           VerticalOptions="Center"/>
                    <Border Grid.Column="1"
                            WidthRequest="32"
                            HeightRequest="32"
                            BackgroundColor="#F5F5F5"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 16"
                            HorizontalOptions="End"
                            VerticalOptions="Center">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding HideDateFilterCommand}"/>
                        </Border.GestureRecognizers>
                        <Label Text="âœ•"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#5B4F45"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
                    </Border>
                </Grid>
                
                <!-- Date inputs -->
                <VerticalStackLayout Grid.Row="1" Spacing="20">
                    <!-- Quick Filters -->
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Quick Filters" 
                               FontSize="14" 
                               FontAttributes="Bold" 
                               TextColor="#5B4F45"/>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="10">
                            <Button Grid.Row="0" Grid.Column="0" 
                                    Text="Today" 
                                    Command="{Binding SetTodayCommand}" 
                                    BackgroundColor="#E8F5E8"
                                    TextColor="#2E7D32"
                                    CornerRadius="8"
                                    HeightRequest="40"/>
                            <Button Grid.Row="0" Grid.Column="1" 
                                    Text="Yesterday" 
                                    Command="{Binding SetYesterdayCommand}" 
                                    BackgroundColor="#E8F5E8"
                                    TextColor="#2E7D32"
                                    CornerRadius="8"
                                    HeightRequest="40"/>
                            <Button Grid.Row="1" Grid.Column="0" 
                                    Text="Last 7 Days" 
                                    Command="{Binding SetLast7DaysCommand}" 
                                    BackgroundColor="#E8F5E8"
                                    TextColor="#2E7D32"
                                    CornerRadius="8"
                                    HeightRequest="40"/>
                            <Button Grid.Row="1" Grid.Column="1" 
                                    Text="Last 30 Days" 
                                    Command="{Binding SetLast30DaysCommand}" 
                                    BackgroundColor="#E8F5E8"
                                    TextColor="#2E7D32"
                                    CornerRadius="8"
                                    HeightRequest="40"/>
                        </Grid>
                    </VerticalStackLayout>
                    
                    <!-- Custom Date Range -->
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Custom Range" 
                               FontSize="14" 
                               FontAttributes="Bold" 
                               TextColor="#5B4F45"/>
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Start Date" 
                                   FontSize="12" 
                                   TextColor="#666666"/>
                            <DatePicker x:Name="HistoryStartDatePicker"
                                       Date="{Binding FilterStartDate, Mode=TwoWay}"
                                       MinimumDate="2020-01-01"
                                       MaximumDate="{Binding FilterEndDate}"
                                       TextColor="#5B4F45"
                                       BackgroundColor="#F5F5F5"
                                       FontSize="14"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Spacing="8">
                            <Label Text="End Date" 
                                   FontSize="12" 
                                   TextColor="#666666"/>
                            <DatePicker x:Name="HistoryEndDatePicker"
                                       Date="{Binding FilterEndDate, Mode=TwoWay}"
                                       MinimumDate="{Binding FilterStartDate}"
                                       MaximumDate="{Binding Today}"
                                       TextColor="#5B4F45"
                                       BackgroundColor="#F5F5F5"
                                       FontSize="14"/>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </VerticalStackLayout>
                
                <!-- Buttons -->
                <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="10">
                    <Button Grid.Column="0" 
                            Text="Clear Filter" 
                            Command="{Binding ClearDateFilterCommand}"
                            BackgroundColor="#E0E0E0" 
                            TextColor="#666666" 
                            CornerRadius="8"
                            HeightRequest="45"/>
                    <Button Grid.Column="1" 
                            Text="Apply Filter" 
                            Command="{Binding ApplyDateFilterCommand}"
                            BackgroundColor="#2E7D32" 
                            TextColor="White" 
                            CornerRadius="8"
                            HeightRequest="45"/>
                </Grid>
            </Grid>
        </Frame>

        <!-- Main Frame -->
        <Frame VerticalOptions="Center"
               HorizontalOptions="Center"
               Padding="0"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               MaximumWidthRequest="900"
               WidthRequest="{OnPlatform Default=900, Android=850, iOS=850, WinUI=900}"
               MaximumHeightRequest="700"
               HeightRequest="{OnPlatform Default=700, Android=650, iOS=650, WinUI=700}"
               HasShadow="True"
               InputTransparent="False">

            <Grid RowDefinitions="Auto, Auto, *">
                <!-- Header -->
                <Grid Grid.Row="0" BackgroundColor="#5B4F45" Padding="20,15">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0" 
                               Text="Transaction History" 
                               FontSize="24" FontFamily="MontserratBlack" 
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="White" />
                        <Button Grid.Column="1"
                                Text="Ã—"
                                Padding="0"
                                FontSize="24" FontFamily="MontserratBlack"
                                FontAttributes="Bold"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                WidthRequest="40"
                                HeightRequest="40"
                                VerticalOptions="Center"
                                Command="{Binding CloseHistoryCommand}" />
                    </Grid>
                </Grid>

                <!-- Filter Buttons -->
                <Grid Grid.Row="1" RowDefinitions="Auto,Auto" Padding="20,25,20,5">
                    <ScrollView Grid.Row="0" Orientation="Horizontal" HorizontalOptions="Center">
                        <HorizontalStackLayout Spacing="10">
                        <!-- Filter Buttons Template -->
                        <Button Text="Today" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="Today" WidthRequest="100" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Today}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="Yesterday" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="Yesterday" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter=Yesterday}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="3 Days Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="3 Days Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='3 Days Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="1 Week Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="1 Week Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='1 Week Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="1 Month Ago" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="1 Month Ago" WidthRequest="120" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='1 Month Ago'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <Button Text="All Time" Command="{Binding FilterByTimePeriodCommand}" CommandParameter="All Time" WidthRequest="100" Style="{StaticResource FilterButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button"
                                             Binding="{Binding SelectedFilter, Converter={StaticResource FilterButtonConverter}, ConverterParameter='All Time'}"
                                             Value="True">
                                    <Setter Property="BackgroundColor" Value="#5B4F45" />
                                    <Setter Property="TextColor" Value="White" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                            <Button Text="ðŸ“… Filter Date" 
                                    Command="{Binding ShowDateFilterCommand}" 
                                    WidthRequest="130" 
                                    Style="{StaticResource FilterButtonStyle}">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button"
                                                 Binding="{Binding HasDateFilter}"
                                                 Value="True">
                                        <Setter Property="BackgroundColor" Value="#5B4F45" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                        </HorizontalStackLayout>
                    </ScrollView>
                    
                    <!-- Date Filter Indicator -->
                    <Grid Grid.Row="1" IsVisible="{Binding HasDateFilter}" Margin="20,5,20,0">
                        <Border BackgroundColor="#E8F5E9" 
                                Stroke="#4CAF50" 
                                StrokeShape="RoundRectangle 8" 
                                StrokeThickness="1" 
                                Padding="10,5">
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Start">
                                <Label Text="ðŸ“…" FontSize="14" VerticalOptions="Center"/>
                                <Label Text="{Binding DateFilterText}" 
                                       FontSize="12" 
                                       TextColor="#2E7D32" 
                                       FontAttributes="Bold"
                                       VerticalOptions="Center"/>
                                <Button Text="âœ•" 
                                        BackgroundColor="Transparent" 
                                        TextColor="#2E7D32" 
                                        FontSize="16"
                                        Padding="5,0"
                                        Command="{Binding ClearDateFilterCommand}"/>
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Grid>

                <!-- Transaction Table -->
                <Frame Grid.Row="2"
                       Margin="20,0,20,20"
                       Padding="0"
                       CornerRadius="15"
                       BackgroundColor="White"
                       HasShadow="False">
                        <ScrollView Orientation="Vertical" VerticalScrollBarVisibility="Default">
                            <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Always">
                                <VerticalStackLayout Spacing="0">
                                    <!-- Header -->
                                    <Grid BackgroundColor="#D6BCA8" Padding="15,10" MinimumWidthRequest="850">
                                        <Grid ColumnDefinitions="35,120,45,120,100,50,50,50,50,70,90,90">
                                            <Label Grid.Column="0" Text="ID" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="1" Text="Drink Name" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black"/>
                                            <Label Grid.Column="2" Text="Qty" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="3" Text="Sizes" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="4" Text="Add On" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="5" Text="Price" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="6" Text="Small" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="7" Text="Medium" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="8" Text="Large" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="9" Text="Addon" FontAttributes="Bold" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="10" Text="Total" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                            <Label Grid.Column="11" Text="Date" FontAttributes="Bold" FontSize="12" FontFamily="MontserratBlack" TextColor="Black" HorizontalOptions="Center"/>
                                        </Grid>
                                    </Grid>

                                    <!-- Scrollable Data -->
                                    <CollectionView ItemsSource="{Binding FilteredTransactions}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Padding="12,8" Margin="0,0,0,1" BackgroundColor="#F9F9F9" MinimumWidthRequest="850" RowDefinitions="Auto">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="35"/>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="45"/>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="100"/>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="90"/>
                                                        <ColumnDefinition Width="90"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Label Grid.Column="0" Text="{Binding TransactionId}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="1" Text="{Binding DrinkName}" FontSize="11" FontFamily="MontserratBlack" TextColor="Black" LineBreakMode="WordWrap" VerticalOptions="Center" MaxLines="2"/>
                                                    <Label Grid.Column="2" Text="{Binding Quantity}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="3" Text="{Binding AllSizesDisplay}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Start" VerticalOptions="Center" TextColor="Black" LineBreakMode="WordWrap" MaxLines="3"/>
                                                    <Label Grid.Column="4" Text="{Binding AddOns}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black" LineBreakMode="WordWrap" MaxLines="2"/>
                                                    <Label Grid.Column="5" Text="{Binding FormattedPrice}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="6" Text="{Binding FormattedSmallPrice}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="7" Text="{Binding FormattedMediumPrice}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="8" Text="{Binding FormattedLargePrice}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="9" Text="{Binding FormattedAddonPrice}" FontSize="10" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="10" Text="{Binding FormattedTotal}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                    <Label Grid.Column="11" Text="{Binding FormattedDate}" FontSize="11" FontFamily="MontserratBlack" HorizontalOptions="Center" VerticalOptions="Center" TextColor="Black"/>
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </ScrollView>
                        </ScrollView>
                </Frame>
            </Grid>
        </Frame>
    </Grid>
</ContentView>
