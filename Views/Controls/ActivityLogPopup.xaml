<?xml version="1.0" encoding="utf-8" ?>
<ContentView 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.ActivityLogPopup"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    x:Name="ActivityLogPopupView"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter"/>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <!-- Background overlay that closes on tap -->
        <BoxView BackgroundColor="#80000000" InputTransparent="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Main popup content -->
        <Frame Grid.Row="0" 
               Grid.Column="0" 
               Grid.RowSpan="2" 
               Grid.ColumnSpan="2"
               BackgroundColor="White" 
               CornerRadius="20" 
               Padding="0" 
               HasShadow="True"
               Margin="20"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               WidthRequest="900"
               HeightRequest="700"
               InputTransparent="False">

            <Grid RowDefinitions="Auto, *, Auto">
                <!-- Header -->
                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="20">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0" 
                               Text="Inventory Activity Log" 
                               FontSize="24" 
                               FontAttributes="Bold" 
                               TextColor="White" 
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1" 
                                Text="âœ•" 
                                BackgroundColor="Transparent" 
                                TextColor="White" 
                                FontSize="20" 
                                FontAttributes="Bold"
                                WidthRequest="40" 
                                HeightRequest="40"
                                Command="{Binding CloseCommand}"/>
                    </Grid>
                </Grid>

                <!-- Content Area -->
                <Grid Grid.Row="1" Padding="20">
                    <!-- Loading Indicator -->
                    <VerticalStackLayout IsVisible="{Binding IsLoading}" 
                                        HorizontalOptions="Center" 
                                        VerticalOptions="Center">
                        <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                         IsVisible="{Binding IsLoading}" 
                                         Color="#7E6D5F"/>
                        <Label Text="Loading activity log..." 
                               TextColor="Black" 
                               FontSize="14" 
                               HorizontalOptions="Center" 
                               Margin="0,10,0,0"/>
                    </VerticalStackLayout>

                    <!-- Filter Controls -->
                    <Grid IsVisible="{Binding IsLoading, Converter={StaticResource InvertBoolConverter}}" 
                          RowDefinitions="Auto, Auto, *" 
                          RowSpacing="15">
                        
                        <!-- Filter Buttons -->
                        <StackLayout Grid.Row="0" Orientation="Horizontal" Spacing="10" HorizontalOptions="Start">
                            <Button Text="All" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="All"
                                    BackgroundColor="LightGray"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="40"
                                    WidthRequest="80"
                                    CornerRadius="5">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="All">
                                        <Setter Property="BackgroundColor" Value="#7E6D5F" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Deductions" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="DEDUCTED"
                                    BackgroundColor="LightGray"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="40"
                                    WidthRequest="100"
                                    CornerRadius="5">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="DEDUCTED">
                                        <Setter Property="BackgroundColor" Value="#7E6D5F" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Additions" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="ADDED"
                                    BackgroundColor="LightGray"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="40"
                                    WidthRequest="100"
                                    CornerRadius="5">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="ADDED">
                                        <Setter Property="BackgroundColor" Value="#7E6D5F" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Purchase Orders" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="PURCHASE_ORDER"
                                    BackgroundColor="LightGray"
                                    TextColor="Black"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="40"
                                    WidthRequest="140"
                                    CornerRadius="5">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="PURCHASE_ORDER">
                                        <Setter Property="BackgroundColor" Value="#7E6D5F" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                        </StackLayout>

                        <!-- Search and Refresh -->
                        <Grid Grid.Row="1" ColumnDefinitions="*, Auto, Auto" ColumnSpacing="10">
                            <Entry Grid.Column="0" 
                                   Placeholder="Search by item name..." 
                                   Text="{Binding SearchText}"
                                   BackgroundColor="White"
                                   TextColor="Black"
                                   PlaceholderColor="Gray"/>
                            <Button Grid.Column="1" 
                                    Text="ðŸ”" 
                                    BackgroundColor="#7E6D5F" 
                                    TextColor="White" 
                                    WidthRequest="50" 
                                    HeightRequest="40"
                                    Command="{Binding SearchCommand}"/>
                            <Button Grid.Column="2" 
                                    Text="ðŸ”„" 
                                    BackgroundColor="#4CAF50" 
                                    TextColor="White" 
                                    WidthRequest="50" 
                                    HeightRequest="40"
                                    Command="{Binding RefreshCommand}"/>
                        </Grid>

                        <!-- Activity Log List -->
                        <CollectionView Grid.Row="2" 
                                        ItemsSource="{Binding FilteredActivityLog}"
                                        BackgroundColor="Transparent">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Padding="15" 
                                           Margin="0,5,0,5" 
                                           CornerRadius="10" 
                                           BackgroundColor="White" 
                                           HasShadow="True">
                                        <Grid ColumnDefinitions="Auto, *, Auto" RowDefinitions="Auto, Auto, Auto" ColumnSpacing="15">
                                            <!-- Action Icon -->
                                            <Frame Grid.Row="0" 
                                                   Grid.Column="0" 
                                                   Grid.RowSpan="3"
                                                   WidthRequest="50" 
                                                   HeightRequest="50" 
                                                   CornerRadius="25" 
                                                   Padding="0" 
                                                   HasShadow="False"
                                                   BackgroundColor="{Binding ColorCode}">
                                                <Label Text="{Binding ActionIcon}" 
                                                       FontSize="20" 
                                                       TextColor="White" 
                                                       HorizontalOptions="Center" 
                                                       VerticalOptions="Center"/>
                                            </Frame>

                                            <!-- Main Content -->
                                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="5">
                                                <Label Text="{Binding ItemName}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold" 
                                                       TextColor="Black"/>
                                                <Label Text="{Binding ActionDisplay}" 
                                                       FontSize="14" 
                                                       TextColor="{Binding ColorCode}" 
                                                       FontAttributes="Bold"/>
                                                <Label Text="{Binding ReasonDisplay}" 
                                                       FontSize="12" 
                                                       TextColor="Gray"/>
                                            </VerticalStackLayout>

                                            <!-- Quantity and Time -->
                                            <VerticalStackLayout Grid.Row="0" Grid.Column="2" Spacing="5" HorizontalOptions="End">
                                                <Label Text="{Binding QuantityChangeDisplay}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{Binding ColorCode}" 
                                                       HorizontalOptions="End"/>
                                                <Label Text="{Binding StockLevelDisplay}" 
                                                       FontSize="12" 
                                                       TextColor="Gray" 
                                                       HorizontalOptions="End"/>
                                                <Label Text="{Binding FormattedTimestamp}" 
                                                       FontSize="11" 
                                                       TextColor="LightGray" 
                                                       HorizontalOptions="End"/>
                                            </VerticalStackLayout>

                                            <!-- User and Order Info -->
                                            <StackLayout Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="10">
                                                <Label Text="{Binding UserEmail, StringFormat='User: {0}'}" 
                                                       FontSize="11" 
                                                       TextColor="Gray" 
                                                       IsVisible="{Binding UserEmail, Converter={StaticResource StringToBoolConverter}}"/>
                                                <Label Text="{Binding OrderId, StringFormat='Order: {0}'}" 
                                                       FontSize="11" 
                                                       TextColor="Gray" 
                                                       IsVisible="{Binding OrderId, Converter={StaticResource StringToBoolConverter}}"/>
                                            </StackLayout>

                                            <!-- Notes -->
                                            <Label Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                                                   Text="{Binding Notes}" 
                                                   FontSize="11" 
                                                   TextColor="DarkGray" 
                                                   IsVisible="{Binding Notes, Converter={StaticResource StringToBoolConverter}}"
                                                   LineBreakMode="WordWrap"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Grid>

                <!-- Footer -->
                <Grid Grid.Row="2" BackgroundColor="#F5F5F5" Padding="20">
                    <Label Text="{Binding StatusMessage}" 
                           TextColor="Gray" 
                           FontSize="12" 
                           HorizontalOptions="Center"/>
                </Grid>
            </Grid>
        </Frame>
    </Grid>
</ContentView>
