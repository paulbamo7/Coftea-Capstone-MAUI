<?xml version="1.0" encoding="utf-8" ?>
<ContentView 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.ActivityLogPopup"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    x:Name="ActivityLogPopupView"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter"/>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <!-- Background overlay that closes on tap -->
        <BoxView BackgroundColor="#80000000" InputTransparent="False" ZIndex="500">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Date Filter Popup -->
        <Frame IsVisible="{Binding IsDateFilterVisible}"
               BackgroundColor="White"
               CornerRadius="15"
               Padding="20"
               WidthRequest="350"
               HeightRequest="400"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               HasShadow="True"
               InputTransparent="False"
               ZIndex="4000">
            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="15">
                <!-- Header -->
                <Label Grid.Row="0" 
                       Text="ðŸ“… Filter by Date Range" 
                       FontSize="18" 
                       FontAttributes="Bold" 
                       TextColor="#5B4F45"
                       HorizontalOptions="Center"/>
                
                <!-- Date inputs -->
                <VerticalStackLayout Grid.Row="1" Spacing="15">
                    <Label Text="From Date:" FontSize="14" FontAttributes="Bold" TextColor="#5B4F45"/>
                    <DatePicker Date="{Binding FilterStartDate}" 
                                Format="yyyy-MM-dd"
                                TextColor="Black"
                                BackgroundColor="#F5F5F5"/>
                    
                    <Label Text="To Date:" FontSize="14" FontAttributes="Bold" TextColor="#5B4F45" Margin="0,10,0,0"/>
                    <DatePicker Date="{Binding FilterEndDate}" 
                                Format="yyyy-MM-dd"
                                TextColor="Black"
                                BackgroundColor="#F5F5F5"/>
                    
                    <Label Text="Quick Filters:" FontSize="14" FontAttributes="Bold" TextColor="#5B4F45" Margin="0,15,0,0"/>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="10">
                        <Button Grid.Row="0" Grid.Column="0" Text="Today" Command="{Binding SetTodayCommand}" 
                                BackgroundColor="#D4A574" TextColor="White" CornerRadius="10"/>
                        <Button Grid.Row="0" Grid.Column="1" Text="Yesterday" Command="{Binding SetYesterdayCommand}" 
                                BackgroundColor="#D4A574" TextColor="White" CornerRadius="10"/>
                        <Button Grid.Row="1" Grid.Column="0" Text="Last 7 Days" Command="{Binding SetLast7DaysCommand}" 
                                BackgroundColor="#D4A574" TextColor="White" CornerRadius="10"/>
                        <Button Grid.Row="1" Grid.Column="1" Text="Last 30 Days" Command="{Binding SetLast30DaysCommand}" 
                                BackgroundColor="#D4A574" TextColor="White" CornerRadius="10"/>
                    </Grid>
                </VerticalStackLayout>
                
                <!-- Buttons -->
                <Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="10">
                    <Button Grid.Column="0" 
                            Text="Clear Filter" 
                            Command="{Binding ClearDateFilterCommand}"
                            BackgroundColor="#BDAEA2" 
                            TextColor="White" 
                            CornerRadius="10"
                            HeightRequest="45"/>
                    <Button Grid.Column="1" 
                            Text="Apply Filter" 
                            Command="{Binding ApplyDateFilterCommand}"
                            BackgroundColor="#4A90E2" 
                            TextColor="White" 
                            CornerRadius="10"
                            HeightRequest="45"/>
                </Grid>
            </Grid>
        </Frame>

        <!-- Main popup content -->
        <Frame BackgroundColor="White" 
               CornerRadius="20" 
               Padding="0" 
               HasShadow="True"
               Margin="20"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               WidthRequest="920"
               HeightRequest="700"
               InputTransparent="False"
               ZIndex="1000">

            <Grid RowDefinitions="Auto, *, Auto">
                <!-- Header -->
                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="20">
                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0" 
                               Text="Inventory Activity Log" 
                               FontSize="24" FontFamily="MontserratBlack" 
                               FontAttributes="Bold" 
                               TextColor="White" 
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1" 
                                    Text="Ã—" 
                                BackgroundColor="Transparent" 
                                TextColor="White" 
                                FontSize="32" 
                                FontAttributes="Bold"
                                WidthRequest="40" 
                                HeightRequest="40"
                                Padding="0"
                                Command="{Binding CloseCommand}"/>
                    </Grid>
                </Grid>

                <!-- Content Area -->
                <Grid Grid.Row="1" Padding="20">
                    <!-- Loading Indicator -->
                    <VerticalStackLayout IsVisible="{Binding IsLoading}" 
                                        HorizontalOptions="Center" 
                                        VerticalOptions="Center">
                        <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                         IsVisible="{Binding IsLoading}" 
                                         Color="#7E6D5F"/>
                        <Label Text="Loading activity log..." 
                               TextColor="Black" 
                               FontSize="14" FontFamily="MontserratBlack" 
                               HorizontalOptions="Center" 
                               Margin="0,10,0,0"/>
                    </VerticalStackLayout>

                    <!-- Filter Controls -->
                    <Grid IsVisible="{Binding IsLoading, Converter={StaticResource InvertBoolConverter}}" 
                          RowDefinitions="Auto, Auto, Auto, *" 
                          RowSpacing="10">
                        
                        <!-- Filter Buttons -->
                        <StackLayout Grid.Row="0" Orientation="Horizontal" Spacing="10" HorizontalOptions="Start">
                            <Button Text="All" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="All"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="45"
                                    WidthRequest="90"
                                    CornerRadius="20">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="All">
                                        <Setter Property="BackgroundColor" Value="#D4A574" />
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="BorderWidth" Value="0" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Deductions" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="DEDUCTED"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="45"
                                    WidthRequest="120"
                                    CornerRadius="20">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="DEDUCTED">
                                        <Setter Property="BackgroundColor" Value="#D4A574" />
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="BorderWidth" Value="0" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Additions" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="ADDED"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="45"
                                    WidthRequest="120"
                                    CornerRadius="20">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="ADDED">
                                        <Setter Property="BackgroundColor" Value="#D4A574" />
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="BorderWidth" Value="0" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Text="Retracted" 
                                    Command="{Binding FilterByActionCommand}" 
                                    CommandParameter="RETRACTED"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    HeightRequest="45"
                                    WidthRequest="120"
                                    CornerRadius="20">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding SelectedFilter}" Value="RETRACTED">
                                        <Setter Property="BackgroundColor" Value="#D4A574" />
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="BorderWidth" Value="0" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                        </StackLayout>

                        <!-- Search and Date Filter -->
                        <Grid Grid.Row="1" ColumnDefinitions="*, Auto, Auto" ColumnSpacing="10">
                            <Border Grid.Column="0" 
                                    Stroke="#8B7355" 
                                    StrokeShape="RoundRectangle 15" 
                                    StrokeThickness="2" 
                                    HeightRequest="45" 
                                    BackgroundColor="White">
                                <Entry Placeholder="Search by item name..." 
                                       Text="{Binding SearchText}"
                                       BackgroundColor="Transparent"
                                       TextColor="Black"
                                       PlaceholderColor="#8B7355"
                                       Margin="15,0"/>
                            </Border>
                            <Button Grid.Column="1" 
                                    Text="ðŸ“… Filter Date" 
                                    BackgroundColor="#BDAEA2" 
                                    TextColor="#5B4F45" 
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    WidthRequest="130" 
                                    HeightRequest="45"
                                    CornerRadius="20"
                                    FontSize="13"
                                    Command="{Binding ShowDateFilterCommand}">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding HasDateFilter}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#D4A574" />
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="BorderWidth" Value="0" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            <Button Grid.Column="2" 
                                    Text="ðŸ”„" 
                                    BackgroundColor="#BDAEA2" 
                                    TextColor="#5B4F45" 
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    WidthRequest="55" 
                                    HeightRequest="45"
                                    CornerRadius="20"
                                    Command="{Binding RefreshCommand}"/>
                        </Grid>
                        
                        <!-- Date Filter Indicator -->
                        <Grid Grid.Row="2" IsVisible="{Binding HasDateFilter}" ColumnDefinitions="*" Margin="0,5,0,0">
                            <Border BackgroundColor="#E8F5E9" 
                                    Stroke="#4CAF50" 
                                    StrokeShape="RoundRectangle 8" 
                                    StrokeThickness="1" 
                                    Padding="10,5">
                                <HorizontalStackLayout Spacing="8" HorizontalOptions="Start">
                                    <Label Text="ðŸ“…" FontSize="14" VerticalOptions="Center"/>
                                    <Label Text="{Binding DateFilterText}" 
                                           FontSize="12" 
                                           TextColor="#2E7D32" 
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                    <Button Text="âœ•" 
                                            BackgroundColor="Transparent" 
                                            TextColor="#2E7D32" 
                                            FontSize="16"
                                            Padding="5,0"
                                            Command="{Binding ClearDateFilterCommand}"/>
                                </HorizontalStackLayout>
                            </Border>
                        </Grid>

                        <!-- Activity Log Table -->
                        <ScrollView Grid.Row="3" Orientation="Vertical" VerticalScrollBarVisibility="Default">
                            <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Always">
                                <VerticalStackLayout Spacing="0">
                                    <!-- Table Header -->
                                    <Grid BackgroundColor="#7E6D5F" Padding="10,8" ColumnSpacing="12" MinimumWidthRequest="1100">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="40"/>   <!-- # -->
                                        <ColumnDefinition Width="120"/>  <!-- Date & Time -->
                                        <ColumnDefinition Width="100"/>  <!-- User -->
                                        <ColumnDefinition Width="90"/>   <!-- Action -->
                                        <ColumnDefinition Width="160"/>  <!-- Item -->
                                        <ColumnDefinition Width="70"/>   <!-- Qty Change -->
                                        <ColumnDefinition Width="60"/>   <!-- UoM -->
                                        <ColumnDefinition Width="70"/>   <!-- Prev Qty -->
                                        <ColumnDefinition Width="70"/>   <!-- New Qty -->
                                        <ColumnDefinition Width="140"/>  <!-- Used for Product -->
                                        <ColumnDefinition Width="120"/>  <!-- Remarks -->
                                    </Grid.ColumnDefinitions>
                                    
                                    <Label Grid.Column="0" Text="#" FontSize="11" FontAttributes="Bold" TextColor="White" HorizontalOptions="Start"/>
                                    <Label Grid.Column="1" Text="Date &amp; Time" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="2" Text="User" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="3" Text="Action" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="4" Text="Item" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="5" Text="Qty Change" FontSize="11" FontAttributes="Bold" TextColor="White" HorizontalOptions="End"/>
                                    <Label Grid.Column="6" Text="UoM" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="7" Text="Prev Qty" FontSize="11" FontAttributes="Bold" TextColor="White" HorizontalOptions="End"/>
                                    <Label Grid.Column="8" Text="New Qty" FontSize="11" FontAttributes="Bold" TextColor="White" HorizontalOptions="End"/>
                                    <Label Grid.Column="9" Text="Used for Product" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="10" Text="Remarks" FontSize="11" FontAttributes="Bold" TextColor="White"/>
                                </Grid>

                                <!-- Table Rows -->
                                <CollectionView ItemsSource="{Binding PagedActivityLog}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="10,8" BackgroundColor="{Binding RowBackgroundColor}" ColumnSpacing="12" MinimumWidthRequest="1100">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="40"/>   <!-- # -->
                                                    <ColumnDefinition Width="120"/>  <!-- Date & Time -->
                                                    <ColumnDefinition Width="100"/>  <!-- User -->
                                                    <ColumnDefinition Width="90"/>   <!-- Action -->
                                                    <ColumnDefinition Width="160"/>  <!-- Item -->
                                                    <ColumnDefinition Width="70"/>   <!-- Qty Change -->
                                                    <ColumnDefinition Width="60"/>   <!-- UoM -->
                                                    <ColumnDefinition Width="70"/>   <!-- Prev Qty -->
                                                    <ColumnDefinition Width="70"/>   <!-- New Qty -->
                                                    <ColumnDefinition Width="140"/>  <!-- Used for Product -->
                                                    <ColumnDefinition Width="120"/>  <!-- Remarks -->
                                                </Grid.ColumnDefinitions>
                                                
                                                <Label Grid.Column="0" Text="{Binding RowNumber}" FontSize="10" TextColor="#333" HorizontalOptions="Start" VerticalOptions="Center"/>
                                                <Label Grid.Column="1" Text="{Binding FormattedTimestampShort}" FontSize="10" TextColor="#333" VerticalOptions="Center"/>
                                                <Label Grid.Column="2" Text="{Binding UserFullName}" FontSize="10" TextColor="#333" LineBreakMode="TailTruncation" VerticalOptions="Center"/>
                                                <Label Grid.Column="3" Text="{Binding ActionText}" FontSize="10" TextColor="{Binding ColorCode}" FontAttributes="Bold" VerticalOptions="Center"/>
                                                <Label Grid.Column="4" Text="{Binding ItemName}" FontSize="10" TextColor="#333" LineBreakMode="TailTruncation" VerticalOptions="Center"/>
                                                <Label Grid.Column="5" Text="{Binding QuantityChangeText}" FontSize="10" TextColor="{Binding ColorCode}" FontAttributes="Bold" HorizontalOptions="End" VerticalOptions="Center"/>
                                                <Label Grid.Column="6" Text="{Binding UnitOfMeasurement}" FontSize="10" TextColor="#666" VerticalOptions="Center"/>
                                                <Label Grid.Column="7" Text="{Binding PreviousQuantityText}" FontSize="10" TextColor="#666" HorizontalOptions="End" VerticalOptions="Center"/>
                                                <Label Grid.Column="8" Text="{Binding NewQuantityText}" FontSize="10" TextColor="#333" FontAttributes="Bold" HorizontalOptions="End" VerticalOptions="Center"/>
                                                <Label Grid.Column="9" Text="{Binding UsedForProductText}" FontSize="10" TextColor="#4A90E2" FontAttributes="Bold" LineBreakMode="TailTruncation" VerticalOptions="Center"/>
                                                <Label Grid.Column="10" Text="{Binding RemarksText}" FontSize="10" TextColor="#666" LineBreakMode="TailTruncation" VerticalOptions="Center"/>
                                                
                                                <!-- Separator Line -->
                                                <BoxView Grid.ColumnSpan="11" HeightRequest="1" BackgroundColor="#E0E0E0" VerticalOptions="End"/>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                                    <!-- Pagination Controls -->
                                    <Grid Padding="10" BackgroundColor="#FFF" ColumnDefinitions="Auto,*,Auto" Margin="0,5,0,0" MinimumWidthRequest="1100">
                                        <Button Grid.Column="0" Text="Prev" BackgroundColor="#BDAEA2" TextColor="#5B4F45" CornerRadius="8"
                                                IsEnabled="{Binding CanGoToPreviousPage}"
                                                Command="{Binding PrevPageCommand}"/>
                                        <Label Grid.Column="1" Text="{Binding CurrentPage, StringFormat='Page {0}'}" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        <Button Grid.Column="2" Text="Next" BackgroundColor="#BDAEA2" TextColor="#5B4F45" CornerRadius="8"
                                                IsEnabled="{Binding CanGoToNextPage}"
                                                Command="{Binding NextPageCommand}"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </ScrollView>
                        </ScrollView>
                    </Grid>
                </Grid>

                <!-- Footer -->
                <Grid Grid.Row="2" BackgroundColor="#F5F5F5" Padding="20">
                    <Label Text="{Binding StatusMessage}" 
                           TextColor="Gray" 
                           FontSize="12" FontFamily="MontserratBlack" 
                           HorizontalOptions="Center"/>
                </Grid>
            </Grid>
        </Frame>
    </Grid>
</ContentView>
