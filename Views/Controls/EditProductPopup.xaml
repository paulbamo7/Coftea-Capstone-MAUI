<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Coftea_Capstone.Views.Controls.EditProductPopup"
             x:Name="EditProductPopupView"
             BackgroundColor="#80000000"
             IsVisible="{Binding IsEditProductPopupVisible}"
             InputTransparent="False">

    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" InputTransparent="False">
        <!-- Background overlay to close on outside tap -->
        <BoxView BackgroundColor="Transparent" Grid.RowSpan="3">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseEditProductPopupCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>
        
        <!-- Popup Frame -->
        <Frame VerticalOptions="Center"
               HorizontalOptions="Center"
               Padding="20"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               WidthRequest="900"
               HeightRequest="700"
               HasShadow="True"
               InputTransparent="False">

            <Grid RowDefinitions="Auto, *, Auto">
                <VerticalStackLayout>
                    <!-- Title -->
                <Label Text="Select Product to Edit"
                       FontSize="24"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       Grid.Row="0"
                       Margin="0,0,0,20" />
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="15" Margin="10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="2"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Text="All" FontAttributes="Bold" FontFamily="MontserratBlack" TextColor="#2b2b2b" FontSize="14"
                                BackgroundColor="#D4C4A3" WidthRequest="100" HeightRequest="40"
                                Command="{Binding FilterByCategoryCommand}" CommandParameter="All">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="#D4C4A3" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="All">
                                            <Setter Property="BackgroundColor" Value="#C79A6A" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <BoxView Grid.Row="1" HeightRequest="2" Color="#C79A6A">
                            <BoxView.Triggers>
                                <DataTrigger TargetType="BoxView" Binding="{Binding SelectedCategory}" Value="All">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </BoxView.Triggers>
                        </BoxView>
                    </Grid>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="2"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Text="Frappe" FontAttributes="Bold" FontFamily="MontserratBlack" TextColor="#2b2b2b" FontSize="14"
                                BackgroundColor="#D4C4A3" WidthRequest="100" HeightRequest="40"
                                Command="{Binding FilterByCategoryCommand}" CommandParameter="Frappe">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="#D4C4A3" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Frappe">
                                            <Setter Property="BackgroundColor" Value="#C79A6A" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <BoxView Grid.Row="1" HeightRequest="2" Color="#C79A6A">
                            <BoxView.Triggers>
                                <DataTrigger TargetType="BoxView" Binding="{Binding SelectedCategory}" Value="Frappe">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </BoxView.Triggers>
                        </BoxView>
                    </Grid>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="2"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Text="Fruit/Soda" FontAttributes="Bold" FontFamily="MontserratBlack" TextColor="#2b2b2b" FontSize="14"
                                BackgroundColor="#D4C4A3" WidthRequest="120" HeightRequest="40"
                                Command="{Binding FilterByCategoryCommand}" CommandParameter="Fruit/Soda">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="#D4C4A3" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Fruit/Soda">
                                            <Setter Property="BackgroundColor" Value="#C79A6A" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <BoxView Grid.Row="1" HeightRequest="2" Color="#C79A6A">
                            <BoxView.Triggers>
                                <DataTrigger TargetType="BoxView" Binding="{Binding SelectedCategory}" Value="Fruit/Soda">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </BoxView.Triggers>
                        </BoxView>
                    </Grid>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="2"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Text="Milktea" FontAttributes="Bold" FontFamily="MontserratBlack" TextColor="#2b2b2b" FontSize="14"
                                BackgroundColor="#D4C4A3" WidthRequest="100" HeightRequest="40"
                                Command="{Binding FilterByCategoryCommand}" CommandParameter="Milktea">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="#D4C4A3" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Milktea">
                                            <Setter Property="BackgroundColor" Value="#C79A6A" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <BoxView Grid.Row="1" HeightRequest="2" Color="#C79A6A">
                            <BoxView.Triggers>
                                <DataTrigger TargetType="BoxView" Binding="{Binding SelectedCategory}" Value="Milktea">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </BoxView.Triggers>
                        </BoxView>
                    </Grid>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="2"/>
                        </Grid.RowDefinitions>
                        <Button Grid.Row="0" Text="Coffee" FontAttributes="Bold" FontFamily="MontserratBlack" TextColor="#2b2b2b" FontSize="14"
                                BackgroundColor="#D4C4A3" WidthRequest="100" HeightRequest="40"
                                Command="{Binding FilterByCategoryCommand}" CommandParameter="Coffee">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="BackgroundColor" Value="#D4C4A3" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Coffee">
                                            <Setter Property="BackgroundColor" Value="#C79A6A" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <BoxView Grid.Row="1" HeightRequest="2" Color="#C79A6A">
                            <BoxView.Triggers>
                                <DataTrigger TargetType="BoxView" Binding="{Binding SelectedCategory}" Value="Coffee">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </BoxView.Triggers>
                        </BoxView>
                    </Grid>
                </HorizontalStackLayout>
                </VerticalStackLayout>
                <!-- Products List -->
                <Border Grid.Row="1" 
                        StrokeShape="RoundRectangle 15" 
                        BackgroundColor="White" 
                        Padding="10">
                    <Grid>
                        <!-- Loading Indicator -->
                        <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                         IsVisible="{Binding IsLoading}" 
                                         VerticalOptions="Center" 
                                         HorizontalOptions="Center" />
                        

                        <!-- Products Collection -->
                        <CollectionView ItemsSource="{Binding Products}"
                                       IsVisible="{Binding IsLoading, Converter={StaticResource NullToBoolConverter}}">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Vertical" Span="2" />
                            </CollectionView.ItemsLayout>

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="#D9D9D9" 
                                           CornerRadius="15" 
                                           Margin="5" 
                                           Padding="10" 
                                           VerticalOptions="Fill" 
                                           HorizontalOptions="Fill">
                                        
                                        <Grid ColumnDefinitions="Auto, *, Auto" RowDefinitions="Auto, Auto, Auto, Auto">
                                            <!-- Product Image -->
                                            <Frame Grid.Row="0" Grid.RowSpan="4" Grid.Column="0"
                                                   CornerRadius="10" 
                                                   Padding="0" 
                                                   HeightRequest="80" 
                                                   WidthRequest="80" 
                                                   Margin="0,0,10,0">
                                                <Image Source="{Binding ImageSource}" 
                                                       Aspect="AspectFill" />
                                            </Frame>

                                            <!-- Product Name -->
                                            <Label Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding ProductName}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="16" 
                                                   VerticalOptions="Start" />

                                            <!-- Category -->
                                            <Label Grid.Row="1" Grid.Column="1"
                                                   Text="{Binding Category, StringFormat='Category: {0}'}" 
                                                   FontSize="12" 
                                                   TextColor="Gray" 
                                                   VerticalOptions="Center" />

                                            <!-- Prices (Small visible only for Coffee; Medium and Large visible for all) -->
                                            <HorizontalStackLayout Grid.Row="2" Grid.Column="1" 
                                                                   Spacing="10" 
                                                                   VerticalOptions="Center">
                                                <!-- Small price - only for Coffee category -->
                                                <Label Text="{Binding SmallPrice, StringFormat='Small: ₱{0:F2}'}" 
                                                       FontSize="12" 
                                                       TextColor="DarkGreen"
                                                       IsVisible="False">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label" Binding="{Binding Category}" Value="Coffee">
                                                            <Setter Property="IsVisible" Value="True" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <!-- Medium price - always visible -->
                                                <Label Text="{Binding MediumPrice, StringFormat='Medium: ₱{0:F2}'}" 
                                                       FontSize="12" 
                                                       TextColor="DarkGreen" />

                                                <!-- Large price - always visible -->
                                                <Label Text="{Binding LargePrice, StringFormat='Large: ₱{0:F2}'}" 
                                                       FontSize="12" 
                                                       TextColor="DarkGreen" />
                                            </HorizontalStackLayout>

                                            <!-- Action Buttons -->
                                            <HorizontalStackLayout Grid.Row="3" Grid.Column="1" 
                                                                   Spacing="10" 
                                                                   VerticalOptions="End"
                                                                   HorizontalOptions="Start">
                                                <Button Text="Edit" 
                                                        FontSize="12" 
                                                        BackgroundColor="#4CAF50" 
                                                        TextColor="White"
                                                        WidthRequest="60" 
                                                        HeightRequest="30"
                                                        Padding="0"
                                                        Command="{Binding BindingContext.EditProductCommand, Source={x:Reference EditProductPopupView}}" 
                                                        CommandParameter="{Binding .}" />
                                                
                                                <Button Text="Delete" 
                                                        FontSize="12" 
                                                        BackgroundColor="#F44336" 
                                                        TextColor="White"
                                                        WidthRequest="60" 
                                                        HeightRequest="30"
                                                        Padding="0"
                                                        IsVisible="{Binding BindingContext.IsAdmin, Source={x:Reference EditProductPopupView}}"
                                                        Command="{Binding BindingContext.DeleteProductCommand, Source={x:Reference EditProductPopupView}}" 
                                                        CommandParameter="{Binding .}" />
                                                
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Border>

                <!-- Close Button -->
                <Button Text="Close"
                        Grid.Row="2"
                        WidthRequest="100"
                        HeightRequest="40"
                        FontSize="14"
                        BackgroundColor="Red"
                        TextColor="White"
                        HorizontalOptions="Center"
                        Margin="0,20,0,0"
                        Command="{Binding CloseEditProductPopupCommand}" />
            </Grid>
        </Frame>
    </Grid>
</ContentView>
