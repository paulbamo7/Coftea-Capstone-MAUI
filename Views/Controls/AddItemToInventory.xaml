<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.AddItemToInventory"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsAddItemToInventoryVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter" />
            <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
            <converters:NullToInvertedBoolConverter x:Key="NullToInvertedBoolConverter" />
            <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
            <converters:ValidationBorderColorConverter x:Key="ValidationBorderColorConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <AbsoluteLayout HorizontalOptions="Fill" VerticalOptions="Fill">
        <!-- Click-blocking overlay -->
        <BoxView BackgroundColor="#80000000" 
                 HorizontalOptions="Fill" 
                 VerticalOptions="Fill"
                 AbsoluteLayout.LayoutBounds="0,0,1,1"
                 AbsoluteLayout.LayoutFlags="All"
                 InputTransparent="{Binding IsAnyDropdownVisible}">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseAddItemToInventoryCommand}"/>
            </BoxView.GestureRecognizers>
        </BoxView>
        
        <!-- Popup Content -->
        <Frame HorizontalOptions="Center" 
               VerticalOptions="Center"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               HasShadow="True"
               Padding="0"
               WidthRequest="1050"
               HeightRequest="700"
               AbsoluteLayout.LayoutBounds="0.5,0.5,-1,-1"
               AbsoluteLayout.LayoutFlags="PositionProportional"
               InputTransparent="False">

            <Grid ColumnDefinitions="500,2,*" RowDefinitions="*" BackgroundColor="#F8E8D7">

                <!-- LEFT PANEL -->
                <VerticalStackLayout Padding="27" BackgroundColor="#F8E8D7">
                    <Label Text="Add Item To Inventory"
                           FontAttributes="Bold"
                           FontSize="28"
                           FontFamily="MontserratBlack"
                           Margin="0,0,0,10"
                           TextColor="#5B4F45" />

                    <!-- STOCK NAME -->
                    <Label Text="STOCK NAME" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45" Padding="0,20,0,0"/>
                    <Border Stroke="{Binding ItemNameValidationMessage, Converter={StaticResource ValidationBorderColorConverter}}" 
                            StrokeShape="RoundRectangle 10" 
                            StrokeThickness="2" 
                            HeightRequest="45"
                            Margin="0,0,0,5">
                        <Entry Placeholder="Enter stock name"
                               Text="{Binding ItemName}"
                               FontSize="17"
                               TextColor="#5B4F45"
                               PlaceholderColor="#8B7355"
                               BackgroundColor="Transparent"
                               Margin="12,0"/>
                    </Border>
                    <Label Text="{Binding ItemNameValidationMessage}"
                           TextColor="#D9534F"
                           FontSize="12"
                           Margin="5,-5,0,5"
                           IsVisible="{Binding ItemNameValidationMessage, Converter={StaticResource StringToBoolConverter}}"/>

                    <!-- PRODUCT CATEGORY -->
                    <Label Text="PRODUCT CATEGORY" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45" Margin="0,20,0,5" />
                    <AbsoluteLayout Margin="0,0,0,5">
                        <Button x:Name="CategoryButton"
                                Text="{Binding CategoryDisplayText}"
                                Command="{Binding ShowCategoryPickerCommand}"
                                BackgroundColor="White"
                                TextColor="#5B4F45"
                                BorderColor="#8B7355"
                                BorderWidth="1"
                                CornerRadius="10"
                                HeightRequest="45"
                                Padding="12,8"
                                AbsoluteLayout.LayoutBounds="0,0,200,45"
                                AbsoluteLayout.LayoutFlags="None"/>
                        
                        <!-- Category Dropdown -->
                        <Frame IsVisible="{Binding IsCategoryDropdownVisible}"
                               BackgroundColor="White"
                               CornerRadius="8"
                               HasShadow="True"
                               Padding="0"
                               WidthRequest="200"
                               MaximumHeightRequest="240"
                               AbsoluteLayout.LayoutBounds="210,0,200,240"
                               AbsoluteLayout.LayoutFlags="None"
                               ZIndex="10000"
                               InputTransparent="False">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="10,6" ColumnDefinitions="*,Auto">
                                    <Label Text="Select Category" 
                                           FontSize="13" FontFamily="MontserratBlack" 
                                           FontAttributes="Bold" 
                                           TextColor="White" 
                                           Grid.Column="0"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                    <Button Text="✕" 
                                            FontSize="14" 
                                            TextColor="White" 
                                            BackgroundColor="Transparent" 
                                            Grid.Column="1"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            HorizontalOptions="End"
                                            VerticalOptions="Center"
                                            Command="{Binding CloseCategoryDropdownCommand}"/>
                                </Grid>
                                <ScrollView Grid.Row="1" 
                                          VerticalOptions="FillAndExpand"
                                          MaximumHeightRequest="200">
                                    <CollectionView ItemsSource="{Binding Categories}"
                                                  SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#F8E8D7" 
                                                   CornerRadius="0" 
                                                   Padding="10,8" 
                                                   HasShadow="False"
                                                   Margin="0,0,0,1"
                                                   MinimumHeightRequest="36">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={x:Reference CategoryButton}, Path=BindingContext.SelectCategoryCommand}" 
                                                                          CommandParameter="{Binding .}"/>
                                                </Frame.GestureRecognizers>
                                                <Label Text="{Binding .}" 
                                                       FontSize="13" 
                                                       FontFamily="OpenSansSemibold"
                                                       TextColor="#5B4F45"
                                                       VerticalOptions="Center"
                                                       VerticalTextAlignment="Center"/>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </ScrollView>
                            </Grid>
                        </Frame>
                    </AbsoluteLayout>

                    <!-- STOCK IMAGE (updated with upload prompt) -->
                    <Label Text="STOCK IMAGE"
                           FontAttributes="Bold"
                           FontSize="18"
                           TextColor="#5B4F45"
                           Margin="0,20,0,5" />

                    <Frame CornerRadius="12"
                           BackgroundColor="White"
                           HasShadow="False"
                           Padding="20"
                           WidthRequest="400"
                           HeightRequest="200">

                        <Grid>
                            <!-- Preview area (visible when an image is selected) -->
                            <Grid IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToBoolConverter}}">
                                <Image Source="{Binding SelectedImageSource}"
                                       Aspect="AspectFill"
                                       WidthRequest="360"
                                       HeightRequest="160" />

                                <ImageButton Source="close.png"
                                             WidthRequest="28"
                                             HeightRequest="28"
                                             BackgroundColor="#80000000"
                                             CornerRadius="14"
                                             HorizontalOptions="End"
                                             VerticalOptions="Start"
                                             Margin="6"
                                             Command="{Binding RemoveImageCommand}" />
                            </Grid>

                            <!-- Upload Placeholder (visible when no image selected) -->
                            <VerticalStackLayout HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               Spacing="10"
                                               IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToInvertedBoolConverter}}">
                                <Image Source="uploadicon.png"
                                       WidthRequest="40"
                                       HeightRequest="40"
                                       Opacity="0.85" />
                                <Label Text="Choose a file or drag and drop it here"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#6B5B3E"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="JPEG, PNG (max 3MB)"
                                       FontSize="12"
                                       TextColor="#9A8A6A"
                                       HorizontalTextAlignment="Center" />
                                <Button Text="Browse File"
                                        Command="{Binding PickImageCommand}"
                                        WidthRequest="120"
                                        HeightRequest="36"
                                        CornerRadius="18"
                                        FontSize="14"
                                        Padding="0"
                                        BackgroundColor="#E0E0E0"
                                        TextColor="#333333"
                                        FontAttributes="Bold" />
                            </VerticalStackLayout>

                            <!-- Invisible overlay so whole area is clickable -->
                            <Button BackgroundColor="Transparent"
                                    Command="{Binding PickImageCommand}"
                                    IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToInvertedBoolConverter}}"
                                    HorizontalOptions="Fill"
                                    VerticalOptions="Fill" />
                        </Grid>
                    </Frame>
                </VerticalStackLayout>

                <!-- VERTICAL SEPARATOR -->
                <BoxView Grid.Column="1"
                         WidthRequest="2"
                         Color="#C9A87C"
                         VerticalOptions="Fill"
                         HorizontalOptions="Center"/>

                <!-- RIGHT PANEL -->
                <ScrollView Grid.Column="2" Padding="30" BackgroundColor="#F8E8D7">
                    <VerticalStackLayout Spacing="15" BackgroundColor="#F8E8D7" Padding="15,0,0,0">

                        <!-- HEADER -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Text="Measurement Details" FontSize="28" FontAttributes="Bold" FontFamily="MontserratBlack" Grid.Column="0" TextColor="#5B4F45" />
                            <ImageButton Source="close.png"
                                         WidthRequest="28"
                                         HeightRequest="28"
                                         Grid.Column="1"
                                         VerticalOptions="Center"
                                         Command="{Binding CloseAddItemToInventoryCommand}"/>
                        </Grid>

                        <!-- STOCK QUANTITY & UOM -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="20">
                            <Label Grid.Column="0" Text="STOCK QUANTITY" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                            <Label Grid.Column="1" Text="UNIT OF MEASUREMENT" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="20" Margin="0,5,0,0">
                            <Border Grid.Column="0"
                                    Stroke="{Binding QuantityValidationMessage, Converter={StaticResource ValidationBorderColorConverter}}" 
                                    StrokeShape="RoundRectangle 10" 
                                    StrokeThickness="2">
                                <Entry Placeholder="Enter stock quantity"
                                       Text="{Binding UoMQuantity}"
                                       Keyboard="Numeric" 
                                       TextColor="#5B4F45" 
                                       PlaceholderColor="#8B7355"
                                       FontSize="16"
                                       BackgroundColor="Transparent"
                                       Margin="12,0"/>
                            </Border>
                            <Border Grid.Column="1"
                                    Stroke="{Binding UoMValidationMessage, Converter={StaticResource ValidationBorderColorConverter}}" 
                                    StrokeShape="RoundRectangle 10" 
                                    StrokeThickness="2">
                                <Picker Title="Select UoM"
                                        ItemsSource="{Binding UoMOptions}"
                                        SelectedItem="{Binding SelectedUoM}"
                                        TitleColor="#8B7355"
                                        FontSize="16" 
                                        TextColor="#5B4F45"
                                        Margin="12,0"/>
                            </Border>
                        </Grid>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="20" Margin="5,-5,0,0">
                            <Label Grid.Column="0"
                                   Text="{Binding QuantityValidationMessage}"
                                   TextColor="#D9534F"
                                   FontSize="12"
                                   IsVisible="{Binding QuantityValidationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                            <Label Grid.Column="1"
                                   Text="{Binding UoMValidationMessage}"
                                   TextColor="#D9534F"
                                   FontSize="12"
                                   IsVisible="{Binding UoMValidationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                        </Grid>

                        <!-- MINIMUM STOCK SECTION -->
                        <VerticalStackLayout Margin="0,20,0,0">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="20">
                                <Label Grid.Column="0" Text="MINIMUM QUANTITY LEVEL" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                                <Label Grid.Column="1" Text="MEASUREMENT" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                            </Grid>
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="20" Margin="0,5,0,0">
                                <Border Grid.Column="0"
                                        Stroke="{Binding MinimumQuantityValidationMessage, Converter={StaticResource ValidationBorderColorConverter}}" 
                                        StrokeShape="RoundRectangle 10" 
                                        StrokeThickness="2">
                                    <Entry Placeholder="Enter minimum quantity"
                                           Text="{Binding MinimumQuantity}"
                                           Keyboard="Numeric" 
                                           TextColor="#5B4F45" 
                                           PlaceholderColor="#8B7355"
                                           FontSize="16"
                                           BackgroundColor="Transparent"
                                           Margin="12,0"/>
                                </Border>
                                <Picker Grid.Column="1"
                                        Title="Select UoM"
                                        ItemsSource="{Binding UoMOptions}"
                                        SelectedItem="{Binding SelectedMinimumUoM}" 
                                        TitleColor="#8B7355"
                                        FontSize="16" 
                                        TextColor="#5B4F45"/>
                            </Grid>
                            <Label Text="{Binding MinimumQuantityValidationMessage}"
                                   TextColor="#D9534F"
                                   FontSize="12"
                                   Margin="5,-5,0,0"
                                   IsVisible="{Binding MinimumQuantityValidationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                        </VerticalStackLayout>

                        <!-- MAXIMUM STOCK SECTION -->
                        <VerticalStackLayout Margin="0,20,0,0">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="20">
                                <Label Grid.Column="0" Text="MAXIMUM QUANTITY LEVEL" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                                <Label Grid.Column="1" Text="MEASUREMENT" FontSize="16" FontAttributes="Bold" TextColor="#5B4F45"/>
                            </Grid>
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="20" Margin="0,5,0,0">
                                <Border Grid.Column="0"
                                        Stroke="{Binding MaximumQuantityValidationMessage, Converter={StaticResource ValidationBorderColorConverter}}" 
                                        StrokeShape="RoundRectangle 10" 
                                        StrokeThickness="2">
                                    <Entry Placeholder="Enter maximum quantity (optional)"
                                           Text="{Binding MaximumQuantity}"
                                           Keyboard="Numeric" 
                                           TextColor="#5B4F45" 
                                           PlaceholderColor="#8B7355"
                                           FontSize="16"
                                           BackgroundColor="Transparent"
                                           Margin="12,0"/>
                                </Border>
                                <Picker Grid.Column="1"
                                        Title="Select UoM"
                                        ItemsSource="{Binding UoMOptions}"
                                        SelectedItem="{Binding SelectedMaximumUoM}" 
                                        TitleColor="#8B7355"
                                        FontSize="16" 
                                        TextColor="#5B4F45"/>
                            </Grid>
                            <Label Text="{Binding MaximumQuantityValidationMessage}"
                                   TextColor="#D9534F"
                                   FontSize="12"
                                   Margin="5,-5,0,0"
                                   IsVisible="{Binding MaximumQuantityValidationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                        </VerticalStackLayout>

                        <!-- DESCRIPTION -->
                        <Label Text="DESCRIPTION (OPTIONAL)" FontSize="18" FontAttributes="Bold" TextColor="#5B4F45" Margin="0,20,0,10"/>
                        <Frame BackgroundColor="White" CornerRadius="15" Padding="15" HasShadow="False" BorderColor="#8B7355" >
                            <Editor Placeholder="Enter item description..." 
                                    HeightRequest="120" 
                                    Text="{Binding ItemDescription}" 
                                    BackgroundColor="Transparent"
                                    TextColor="#5B4F45"
                                    PlaceholderColor="#8B7355"
                                    FontSize="16"/>
                        </Frame>

                        <!-- General Validation Message -->
                        <Frame IsVisible="{Binding GeneralValidationMessage, Converter={StaticResource StringToBoolConverter}}" 
                               BackgroundColor="#FFE8E8" 
                               Padding="15,10" 
                               CornerRadius="10" 
                               Margin="0,10,0,0"
                               HasShadow="False">
                            <StackLayout Orientation="Horizontal" Spacing="8">
                                <Label Text="✗" TextColor="#D9534F" FontSize="14" FontFamily="MontserratBlack"/>
                                <Label Text="{Binding GeneralValidationMessage}" FontSize="13" TextColor="#D9534F" FontFamily="MontserratBlack"/>
                            </StackLayout>
                        </Frame>

                        <!-- BUTTONS -->
                        <HorizontalStackLayout HorizontalOptions="End" Spacing="15" Margin="0,20,0,0">
                            <Button Text="Cancel"
                                    WidthRequest="140"
                                    HeightRequest="50"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    CornerRadius="20"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    Command="{Binding CloseAddItemToInventoryCommand}"/>

                            <Button Text="Add Item"
                                    WidthRequest="140"
                                    HeightRequest="50"
                                    BackgroundColor="#5B4F45"
                                    TextColor="White"
                                    CornerRadius="20"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    Command="{Binding AddItemCommand}"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Grid>
        </Frame>
        
    </AbsoluteLayout>
</ContentView>