<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
             x:Class="Coftea_Capstone.Views.Controls.ConnectPOSItemToInventory"
             BackgroundColor="#80000000"
             IsVisible="{Binding IsConnectPOSToInventoryVisible}"
             HorizontalOptions="FillAndExpand"
             VerticalOptions="FillAndExpand"
             Padding="0">

    <!-- Popup Background -->
    <Grid HorizontalOptions="FillAndExpand"
          VerticalOptions="FillAndExpand"
          RowDefinitions="*,Auto,*"
          ColumnDefinitions="*,Auto,*">

        <!-- Transparent Click-Close Overlay -->
        <BoxView Grid.RowSpan="3" Grid.ColumnSpan="3"
                 BackgroundColor="#80000000">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseConnectPOSToInventoryCommand}" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Center Popup -->
        <Frame Grid.Row="1" Grid.Column="1"
               CornerRadius="25"
               Padding="0"
               WidthRequest="1006"
               HeightRequest="720"
               BackgroundColor="#F8E8D7"
               HasShadow="True"
               BorderColor="#DDDDDD"
               TranslationY="10">

            <!-- MAIN GRID FOR HEADER, CONTENT, FOOTER -->
            <Grid Padding="25" RowSpacing="15"
                  RowDefinitions="Auto,*,Auto">

                <!-- HEADER -->
                <HorizontalStackLayout Grid.Row="0" VerticalOptions="Start" HorizontalOptions="FillAndExpand">
                    <Label Text="Connect POS to Inventory"
                           FontAttributes="Bold"
                           FontSize="26"
                           TextColor="#3C3C3C"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>

                <!-- CONTENT SECTION -->
                <ScrollView Grid.Row="1">
                    <VerticalStackLayout Spacing="15">

                        <!-- Divider -->
                        <BoxView HeightRequest="1" Color="#DDD" />

                        <!-- Filter / Sort Controls -->
                        <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                            <HorizontalStackLayout Spacing="10" Padding="5,0">
                                <Frame CornerRadius="12"
                                       Padding="0"
                                       BackgroundColor="White"
                                       HasShadow="False"
                                       VerticalOptions="Center">
                                    <Picker Title="Select Category"
                                            ItemsSource="{Binding CategoryFilters}"
                                            SelectedItem="{Binding SelectedFilter}"
                                            FontSize="14"
                                            TextColor="Black" />
                                </Frame>

                                <Button Text="ðŸ”„ Refresh" 
                                        BackgroundColor="#D4A574" 
                                        TextColor="White" 
                                        BorderColor="#8B7355"
                                        BorderWidth="2"
                                        FontAttributes="Bold"
                                        FontSize="13"
                                        HeightRequest="40"
                                        WidthRequest="100"
                                        CornerRadius="20"
                                        Padding="10,0"
                                        Command="{Binding RefreshInventoryCommand}"/>

                                <!-- Sort -->
                                <Frame CornerRadius="12" Padding="8,0" BackgroundColor="White" HasShadow="False" VerticalOptions="Center">
                                    <Picker Title="Sort By" 
                                            SelectedItem="{Binding SelectedSort}" 
                                            FontSize="14"
                                            TextColor="Black">
                                        <Picker.Items>
                                            <x:String>Name (A-Z)</x:String>
                                            <x:String>Name (Z-A)</x:String>
                                            <x:String>Quantity (Low to High)</x:String>
                                            <x:String>Quantity (High to Low)</x:String>
                                        </Picker.Items>
                                    </Picker>
                                </Frame>

                                <!-- Search -->
                                <Frame CornerRadius="12" Padding="0" BackgroundColor="White" HasShadow="False" VerticalOptions="Center">
                                    <SearchBar Placeholder="Search"
                                               WidthRequest="220"
                                               Text="{Binding SearchText}"
                                               TextColor="Black"
                                               BackgroundColor="Transparent"
                                               FontSize="16"/>
                                </Frame>
                                <Button Text="âœ• Unselect All" 
                                        Command="{Binding UnselectAllVisibleCommand}" 
                                        BackgroundColor="#BDAEA2" 
                                        TextColor="#5B4F45" 
                                        BorderColor="#8B7355"
                                        BorderWidth="2"
                                        FontSize="13"
                                        FontFamily="OpenSans-Semibold"
                                        FontAttributes="Bold"
                                        HeightRequest="40"
                                        WidthRequest="120"
                                        CornerRadius="20"
                                        Padding="10,0"/>
                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Inventory Content -->
                        <Frame BackgroundColor="White"
                               CornerRadius="15"
                               HasShadow="True"
                               Padding="0">
                            <VerticalStackLayout Spacing="10" Padding="20">

                                <VerticalStackLayout Spacing="8">
                                    <Label Text="SELECT FROM INVENTORY"
                                           FontAttributes="Bold"
                                           FontSize="18"
                                           TextColor="#3C3C3C" />
                                    <Frame BackgroundColor="#E8F5E8"
                                           CornerRadius="8"
                                           Padding="12,8"
                                           HasShadow="False">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="â„¹"
                                                   FontSize="16"
                                                   TextColor="#2E7D32"
                                                   VerticalOptions="Center"/>
                                            <Label Text="Cups are size-specific (Small Cup for Small, Medium Cup for Medium, Large Cup for Large). Straws are included for all sizes."
                                                   FontSize="13"
                                                   TextColor="#2E7D32"
                                                   VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </Frame>
                                </VerticalStackLayout>

                                <!-- Table Header -->
                                <Grid ColumnDefinitions="1*,1*,2*" BackgroundColor="#DAAB97" Padding="12,6" >
                                    <Label Grid.Column="0" Text="ITEMS" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="1" Text="CATEGORY" FontAttributes="Bold" TextColor="White"/>
                                    <Label Grid.Column="2" Text="STOCKS" FontAttributes="Bold" TextColor="White"/>
                                </Grid>

                                <!-- Scrollable Inventory List -->
                                <CollectionView ItemsSource="{Binding InventoryItems}"
                                                VerticalOptions="Start"
                                                SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#FAFAFA"
                                                   CornerRadius="12"
                                                   Padding="12"
                                                   Margin="0,5"
                                                   HasShadow="False"
                                                   BorderColor="#E5D2C1">
                                                <Frame.Triggers>
                                                    <DataTrigger TargetType="Frame"
                                                                 Binding="{Binding IsSelected}"
                                                                 Value="True">
                                                        <Setter Property="BackgroundColor" Value="#F2E6DA" />
                                                        <Setter Property="BorderColor" Value="#D4A574" />
                                                    </DataTrigger>
                                                </Frame.Triggers>
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}}, Path=BindingContext.ToggleSelectCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Frame.GestureRecognizers>

                                                <Grid RowDefinitions="Auto,Auto">
                                                    <Grid Grid.Row="0"
                                                          ColumnDefinitions="Auto,*,Auto"
                                                          ColumnSpacing="12"
                                                          VerticalOptions="Center">
                                                        <HorizontalStackLayout Grid.Column="0"
                                                                                Spacing="10"
                                                                                VerticalOptions="Center">
                                                            <CheckBox IsChecked="{Binding IsSelected}"
                                                                      Color="#5B4F45"
                                                                      MinimumWidthRequest="24"
                                                                      MinimumHeightRequest="24"
                                                                      InputTransparent="True" />
                                                            <Frame WidthRequest="44"
                                                                   HeightRequest="44"
                                                                   CornerRadius="10"
                                                                   Padding="0"
                                                                   HasShadow="False"
                                                                   BackgroundColor="#EFEFEF">
                                                                <Image Source="{Binding ImageSource}"
                                                                       Aspect="AspectFill" />
                                                            </Frame>
                                                        </HorizontalStackLayout>

                                                        <VerticalStackLayout Grid.Column="1"
                                                                              Spacing="2"
                                                                              VerticalOptions="Center">
                                                            <Label Text="{Binding itemName}"
                                                                   FontAttributes="Bold"
                                                                   FontSize="14"
                                                                   TextColor="#3C3C3C" />
                                                            <Label Text="{Binding itemCategory}"
                                                                   FontSize="12"
                                                                   TextColor="#7A6B5E" />
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="2"
                                                                              Spacing="4"
                                                                              HorizontalOptions="End"
                                                                              VerticalOptions="Center">
                                                            <Frame BackgroundColor="White"
                                                                   CornerRadius="10"
                                                                   Padding="8"
                                                                   HasShadow="True">
                                                                <Label FormattedText="{Binding NewStockDisplayFormatted}"
                                                                       FontSize="13"
                                                                       HorizontalOptions="Start"
                                                                       VerticalOptions="Center"
                                                                       LineBreakMode="WordWrap"
                                                                       MaxLines="2" />
                                                            </Frame>
                                                        </VerticalStackLayout>
                                                    </Grid>

                                                    <Border Grid.Row="1"
                                                            BackgroundColor="#FFFFFF"
                                                            Stroke="#E5D2C1"
                                                            Margin="0,12,0,0"
                                                            Padding="12"
                                                            IsVisible="{Binding IsExpanded}">
                                                        <Border.StrokeShape>
                                                            <shapes:RoundRectangle CornerRadius="10" />
                                                        </Border.StrokeShape>
                                                        <VerticalStackLayout Spacing="10">
                                                            <Label Text="{Binding NewStockDisplay}"
                                                                   FontSize="12"
                                                                   TextColor="#3C3C3C"
                                                                   LineBreakMode="WordWrap" />
                                                            <Label Text="{Binding itemDescription}"
                                                                   FontSize="12"
                                                                   TextColor="#5B4F45"
                                                                   LineBreakMode="WordWrap" />
                                                            <HorizontalStackLayout Spacing="10">
                                                                <Button Text="Edit Item"
                                                                        BackgroundColor="#5B4F45"
                                                                        TextColor="White"
                                                                        FontSize="13"
                                                                        FontAttributes="Bold"
                                                                        WidthRequest="110"
                                                                        HeightRequest="36"
                                                                        CornerRadius="18"
                                                                        Padding="0"
                                                                        IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentView}}, Path=BindingContext.CanManageInventory}"
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}}, Path=BindingContext.EditInventoryItemCommand}"
                                                                        CommandParameter="{Binding .}" />
                                                                <Button Text="Unselect"
                                                                        BackgroundColor="#BDAEA2"
                                                                        TextColor="#5B4F45"
                                                                        FontSize="13"
                                                                        WidthRequest="110"
                                                                        HeightRequest="36"
                                                                        CornerRadius="18"
                                                                        Padding="0"
                                                                        IsVisible="{Binding IsSelected}"
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}}, Path=BindingContext.ToggleSelectCommand}"
                                                                        CommandParameter="{Binding .}" />
                                                            </HorizontalStackLayout>
                                                        </VerticalStackLayout>
                                                    </Border>
                                                </Grid>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                            </VerticalStackLayout>
                        </Frame>

                    </VerticalStackLayout>
                </ScrollView>

                <!-- FOOTER -->
                <HorizontalStackLayout Grid.Row="2"
                                       HorizontalOptions="End"
                                       Spacing="15"
                                       Padding="0,10,0,10">
                    <Button Text="â† Return" 
                            BackgroundColor="#BDAEA2" 
                            TextColor="#5B4F45"
                            BorderColor="#8B7355"
                            BorderWidth="2"
                            FontSize="15"
                            FontAttributes="Bold"
                            Command="{Binding CloseConnectPOSToInventoryCommand}" 
                            WidthRequest="140"
                            HeightRequest="50"
                            CornerRadius="20"/>
                    <Button Text="Next â†’" 
                            BackgroundColor="#5B4F45" 
                            TextColor="White"
                            BorderWidth="0"
                            FontSize="15"
                            FontAttributes="Bold"
                            Command="{Binding OpenInputIngredientsCommand}" 
                            WidthRequest="140"
                            HeightRequest="50"
                            CornerRadius="20"/>
                </HorizontalStackLayout>

            </Grid>
        </Frame>
    </Grid>
</ContentView>
