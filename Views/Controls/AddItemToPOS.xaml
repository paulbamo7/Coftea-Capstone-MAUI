<?xml version="1.0" encoding="utf-8"?>
<ContentView
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="Coftea_Capstone.Views.Controls.AddItemToPOS"
    xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
    BackgroundColor="#80000000"
    IsVisible="{Binding IsAddItemToPOSVisible}"
    InputTransparent="False">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter" />
            <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
            <converters:NullToInvertedBoolConverter x:Key="NullToInvertedBoolConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <AbsoluteLayout HorizontalOptions="Fill" VerticalOptions="Fill">
        <!-- Click-blocking overlay -->
        <BoxView BackgroundColor="#80000000" 
                 HorizontalOptions="Fill" 
                 VerticalOptions="Fill"
                 AbsoluteLayout.LayoutBounds="0,0,1,1"
                 AbsoluteLayout.LayoutFlags="All"
                 InputTransparent="{Binding IsAnyDropdownVisible}">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseAddItemToPOSCommand}"/>
            </BoxView.GestureRecognizers>
        </BoxView>
        
        <!-- Popup Content -->
        <Frame HorizontalOptions="Center" 
               VerticalOptions="Center"
               BackgroundColor="#F8E8D7"
               CornerRadius="20"
               HasShadow="True"
               Padding="0"
               WidthRequest="1050"
               HeightRequest="700"
               AbsoluteLayout.LayoutBounds="0.5,0.5,-1,-1"
               AbsoluteLayout.LayoutFlags="PositionProportional"
               InputTransparent="False">

            <Grid ColumnDefinitions="500,2,*" RowDefinitions="*" BackgroundColor="#F8E8D7">

                <!-- LEFT PANEL -->
                <VerticalStackLayout Padding="27" BackgroundColor="#F8E8D7">
                    <Label Text="Add Item to POS"
                           FontAttributes="Bold"
                           FontSize="28" FontFamily="Montserrat-Black"
                           Margin="0,0,0,20"
                           TextColor="#5B4F45" />

                    <!-- PRODUCT NAME -->
                    <Label Text="PRODUCT NAME" FontAttributes="Bold" FontSize="18" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Padding="0,20,0,0"/>
                    <Entry Placeholder="Enter product name"
                           Text="{Binding ProductName}"
                           Margin="0,0,0,10"
                           FontSize="17"
                           TextColor="#5B4F45"
                           PlaceholderColor="#8B7355"
                           HeightRequest="45"/>

                    <!-- CATEGORY -->
                    <Label Text="CATEGORY" FontAttributes="Bold" FontSize="18" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,20,0,5" />
                    <AbsoluteLayout>
                        <Button x:Name="CategoryButton"
                                Text="{Binding CategoryDisplayText}"
                                Command="{Binding ShowCategoryPickerCommand}"
                                BackgroundColor="White"
                                TextColor="#5B4F45"
                                BorderColor="#8B7355"
                                BorderWidth="1"
                                CornerRadius="10"
                                HeightRequest="45"
                                Padding="12,8"
                                AbsoluteLayout.LayoutBounds="0,0,200,45"
                                AbsoluteLayout.LayoutFlags="None"/>
                        
                        <!-- Category Dropdown -->
                        <Frame IsVisible="{Binding IsCategoryDropdownVisible}"
                               BackgroundColor="White"
                               CornerRadius="8"
                               HasShadow="True"
                               Padding="0"
                               WidthRequest="200"
                               AbsoluteLayout.LayoutBounds="210,0,200,300"
                               AbsoluteLayout.LayoutFlags="None"
                               ZIndex="10000"
                               InputTransparent="False">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="12,8" ColumnDefinitions="*,Auto">
                                    <Label Text="Select Category" 
                                           FontSize="14" FontFamily="MontserratBlack" 
                                           FontAttributes="Bold" 
                                           TextColor="White" 
                                           Grid.Column="0"
                                           HorizontalOptions="Center"/>
                                    <Button Text="✕" 
                                            FontSize="14" 
                                            TextColor="White" 
                                            BackgroundColor="Transparent" 
                                            Grid.Column="1"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            HorizontalOptions="End"
                                            VerticalOptions="Center"
                                            Command="{Binding CloseCategoryDropdownCommand}"/>
                                </Grid>
                                <ScrollView Grid.Row="1" 
                                          VerticalOptions="FillAndExpand">
                                    <CollectionView ItemsSource="{Binding Categories}"
                                                  SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#F8E8D7" 
                                                   CornerRadius="0" 
                                                   Padding="12,10" 
                                                   HasShadow="False"
                                                   Margin="0,0,0,2">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={x:Reference CategoryButton}, Path=BindingContext.SelectCategoryCommand}" 
                                                                          CommandParameter="{Binding .}"/>
                                                </Frame.GestureRecognizers>
                                                <Label Text="{Binding .}" 
                                                       FontSize="14" 
                                                       FontFamily="OpenSansSemibold"
                                                       TextColor="#5B4F45"/>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </ScrollView>
                            </Grid>
                        </Frame>
                    </AbsoluteLayout>

                    <!-- SUBCATEGORY for Fruit/Soda -->
                    <Label Text="SUBCATEGORY" FontAttributes="Bold" FontSize="18" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,20,0,5"
                           IsVisible="{Binding IsFruitSodaSubcategoryVisible}" />
                    <AbsoluteLayout IsVisible="{Binding IsFruitSodaSubcategoryVisible}">
                        <Button x:Name="FruitSodaSubcategoryButton"
                                Text="{Binding SubcategoryDisplayText}"
                                Command="{Binding ShowSubcategoryPickerCommand}"
                                BackgroundColor="White"
                                TextColor="#5B4F45"
                                BorderColor="#8B7355"
                                BorderWidth="1"
                                CornerRadius="10"
                                HeightRequest="45"
                                HorizontalOptions="Start"
                                Padding="12,8"
                                AbsoluteLayout.LayoutBounds="0,0,200,45"
                                AbsoluteLayout.LayoutFlags="None"/>
                        
                        <!-- Subcategory Dropdown -->
                        <Frame IsVisible="{Binding IsSubcategoryDropdownVisible}"
                               BackgroundColor="White"
                               CornerRadius="8"
                               HasShadow="True"
                               Padding="0"
                               WidthRequest="200"
                               AbsoluteLayout.LayoutBounds="210,0,200,200"
                               AbsoluteLayout.LayoutFlags="None"
                               ZIndex="10000"
                               InputTransparent="False">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="12,8" ColumnDefinitions="*,Auto">
                                    <Label Text="Select Subcategory" 
                                           FontSize="14" FontFamily="MontserratBlack" 
                                           FontAttributes="Bold" 
                                           TextColor="White" 
                                           Grid.Column="0"
                                           HorizontalOptions="Center"/>
                                    <Button Text="✕" 
                                            FontSize="14" 
                                            TextColor="White" 
                                            BackgroundColor="Transparent" 
                                            Grid.Column="1"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            HorizontalOptions="End"
                                            VerticalOptions="Center"
                                            Command="{Binding CloseSubcategoryDropdownCommand}"/>
                                </Grid>
                                <ScrollView Grid.Row="1">
                                    <CollectionView ItemsSource="{Binding FruitSodaSubcategories}"
                                                  SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#F8E8D7" 
                                                   CornerRadius="0" 
                                                   Padding="12,10" 
                                                   HasShadow="False"
                                                   Margin="0,0,0,2">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={x:Reference FruitSodaSubcategoryButton}, Path=BindingContext.SelectSubcategoryCommand}" 
                                                                          CommandParameter="{Binding .}"/>
                                                </Frame.GestureRecognizers>
                                                <Label Text="{Binding .}" 
                                                       FontSize="14" 
                                                       FontFamily="OpenSansSemibold"
                                                       TextColor="#5B4F45"/>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </ScrollView>
                            </Grid>
                        </Frame>
                    </AbsoluteLayout>

                    <!-- SUBCATEGORY for Coffee -->
                    <Label Text="SUBCATEGORY" FontAttributes="Bold" FontSize="18" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,20,0,5"
                           IsVisible="{Binding IsCoffeeSubcategoryVisible}" />
                    <AbsoluteLayout IsVisible="{Binding IsCoffeeSubcategoryVisible}">
                        <Button x:Name="CoffeeSubcategoryButton"
                                Text="{Binding SubcategoryDisplayText}"
                                Command="{Binding ShowSubcategoryPickerCommand}"
                                BackgroundColor="White"
                                TextColor="#5B4F45"
                                BorderColor="#8B7355"
                                BorderWidth="1"
                                CornerRadius="10"
                                HeightRequest="45"
                                HorizontalOptions="Start"
                                Padding="12,8"
                                AbsoluteLayout.LayoutBounds="0,0,200,45"
                                AbsoluteLayout.LayoutFlags="None"/>
                        
                        <!-- Subcategory Dropdown -->
                        <Frame IsVisible="{Binding IsSubcategoryDropdownVisible}"
                               BackgroundColor="White"
                               CornerRadius="8"
                               HasShadow="True"
                               Padding="0"
                               WidthRequest="200"
                               AbsoluteLayout.LayoutBounds="210,0,200,200"
                               AbsoluteLayout.LayoutFlags="None"
                               ZIndex="10000"
                               InputTransparent="False">
                            <Grid RowDefinitions="Auto,*">
                                <Grid Grid.Row="0" BackgroundColor="#7E6D5F" Padding="12,8" ColumnDefinitions="*,Auto">
                                    <Label Text="Select Subcategory" 
                                           FontSize="14" FontFamily="MontserratBlack" 
                                           FontAttributes="Bold" 
                                           TextColor="White" 
                                           Grid.Column="0"
                                           HorizontalOptions="Center"/>
                                    <Button Text="✕" 
                                            FontSize="14" 
                                            TextColor="White" 
                                            BackgroundColor="Transparent" 
                                            Grid.Column="1"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            HorizontalOptions="End"
                                            VerticalOptions="Center"
                                            Command="{Binding CloseSubcategoryDropdownCommand}"/>
                                </Grid>
                                <ScrollView Grid.Row="1">
                                    <CollectionView ItemsSource="{Binding CoffeeSubcategories}"
                                                  SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="#F8E8D7" 
                                                   CornerRadius="0" 
                                                   Padding="12,10" 
                                                   HasShadow="False"
                                                   Margin="0,0,0,2">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={x:Reference CoffeeSubcategoryButton}, Path=BindingContext.SelectSubcategoryCommand}" 
                                                                          CommandParameter="{Binding .}"/>
                                                </Frame.GestureRecognizers>
                                                <Label Text="{Binding .}" 
                                                       FontSize="14" 
                                                       FontFamily="OpenSansSemibold"
                                                       TextColor="#5B4F45"/>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </ScrollView>
                            </Grid>
                        </Frame>
                    </AbsoluteLayout>

                    <!-- PRODUCT IMAGE -->
                    <Label Text="PRODUCT IMAGE" FontAttributes="Bold" FontSize="16" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,20,0,5" />
                    <Frame CornerRadius="12"
                           BackgroundColor="White"
                           HasShadow="False"
                           Padding="20"
                           WidthRequest="400"
                           HeightRequest="200">

                        <Grid>
                            <!-- Preview when image selected -->
                            <Grid IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToBoolConverter}}">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PickImageCommand}" />
                                </Grid.GestureRecognizers>
                                
                                <Image Source="{Binding SelectedImageSource}"
                                       Aspect="AspectFill"
                                       WidthRequest="360"
                                       HeightRequest="160" />

                                <ImageButton Source="close.png"
                                             WidthRequest="28"
                                             HeightRequest="28"
                                             BackgroundColor="#80000000"
                                             CornerRadius="14"
                                             HorizontalOptions="End"
                                             VerticalOptions="Start"
                                             Margin="6"
                                             Command="{Binding RemoveImageCommand}" />
                            </Grid>

                            <!-- Upload placeholder -->
                            <VerticalStackLayout HorizontalOptions="Center"
                                                 VerticalOptions="Center"
                                                 Spacing="10"
                                                 IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToInvertedBoolConverter}}">
                                <Image Source="uploadicon.png"
                                       WidthRequest="40"
                                       HeightRequest="40"
                                       Opacity="0.85" />
                                <Label Text="Choose a file or drag and drop it here"
                                       FontSize="14" FontFamily="OpenSans-Semibold"
                                       FontAttributes="Bold"
                                       TextColor="#8B7355"
                                       HorizontalTextAlignment="Center" />
                                <Label Text="JPEG, PNG (max 3MB)"
                                       FontSize="12" FontFamily="OpenSans-Regular"
                                       TextColor="#8B7355"
                                       HorizontalTextAlignment="Center" />
                                <Button Text="Browse File"
                                        Command="{Binding PickImageCommand}"
                                        WidthRequest="120"
                                        HeightRequest="36"
                                        CornerRadius="18"
                                        FontSize="14" FontFamily="OpenSans-Semibold"
                                        Padding="0"
                                        BackgroundColor="#BDAEA2"
                                        TextColor="#5B4F45"
                                        FontAttributes="Bold" />
                            </VerticalStackLayout>

                            <Button BackgroundColor="Transparent"
                                    Command="{Binding PickImageCommand}"
                                    IsVisible="{Binding SelectedImageSource, Converter={StaticResource NullToInvertedBoolConverter}}"
                                    HorizontalOptions="Fill"
                                    VerticalOptions="Fill" />
                        </Grid>
                    </Frame>

                </VerticalStackLayout>

                <!-- VERTICAL SEPARATOR -->
                <BoxView Grid.Column="1"
                         WidthRequest="2"
                         Color="#C9A87C"
                         VerticalOptions="Fill"
                         HorizontalOptions="Center"/>

                <!-- RIGHT PANEL -->
                <ScrollView Grid.Column="2" Padding="30" BackgroundColor="#F8E8D7">
                    <VerticalStackLayout Spacing="15" BackgroundColor="#F8E8D7" Padding="20,0,0,0">

                        <!-- HEADER -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Text="Product Pricing" FontSize="28" FontFamily="Montserrat-Black" FontAttributes="Bold" Grid.Column="0" TextColor="#5B4F45" />
                            <ImageButton Source="close.png"
                                         WidthRequest="25"
                                         HeightRequest="25"
                                         Grid.Column="1"
                                         VerticalOptions="Center"
                                         Command="{Binding CloseAddItemToPOSCommand}"/>
                        </Grid>

                        <!-- PRICE INPUTS -->
                        <Label Text="SET PRODUCT PRICES" FontAttributes="Bold" FontSize="16" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,10,0,5"/>

                        <HorizontalStackLayout Spacing="15">
                            <!-- Small price - only visible for Coffee category -->
                            <VerticalStackLayout IsVisible="{Binding IsSmallPriceVisible}">
                                <Label Text="SMALL" FontAttributes="Bold" FontSize="14" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,0,0,5"/>
                                <Entry Placeholder="Small Price"
                                       Text="{Binding SmallPrice}"
                                       Keyboard="Numeric"
                                       TextColor="#5B4F45"
                                       PlaceholderColor="#8B7355"
                                       FontSize="15"
                                       WidthRequest="140"
                                       HeightRequest="55"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout>
                                <Label Text="MEDIUM" FontAttributes="Bold" FontSize="14" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,0,0,5"/>
                                <Entry Placeholder="Medium Price"
                                       Text="{Binding MediumPrice}"
                                       Keyboard="Numeric"
                                       TextColor="#5B4F45"
                                       PlaceholderColor="#8B7355"
                                       FontSize="15"
                                       WidthRequest="140"
                                       HeightRequest="55"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout>
                                <Label Text="LARGE" FontAttributes="Bold" FontSize="14" FontFamily="OpenSansSemibold" TextColor="#5B4F45" Margin="0,0,0,5"/>
                                <Entry Placeholder="Large Price"
                                       Text="{Binding LargePrice}"
                                       Keyboard="Numeric"
                                       TextColor="#5B4F45"
                                       PlaceholderColor="#8B7355"
                                       FontSize="15"
                                       WidthRequest="140"
                                       HeightRequest="55"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <!-- DESCRIPTION -->
                        <Label Text="DESCRIPTION (OPTIONAL)" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45" Margin="0,20,0,10"/>
                        <Frame BackgroundColor="White" CornerRadius="15" Padding="15" HasShadow="False" BorderColor="#8B7355">
                            <Editor Placeholder="Enter product description..."
                                    Text="{Binding ProductDescription}"
                                    HeightRequest="120"
                                    FontSize="16"
                                    BackgroundColor="Transparent"
                                    TextColor="#5B4F45"
                                    PlaceholderColor="#8B7355"/>
                        </Frame>

                        <!-- BUTTONS -->
                        <HorizontalStackLayout HorizontalOptions="End" Spacing="20" Margin="0,20,0,0">
                            <Button Text="Cancel"
                                    WidthRequest="130"
                                    HeightRequest="50"
                                    BackgroundColor="#BDAEA2"
                                    TextColor="#5B4F45"
                                    BorderColor="#8B7355"
                                    BorderWidth="2"
                                    Command="{Binding CloseAddItemToPOSCommand}"
                                    CornerRadius="20"
                                    FontSize="15"
                                    Padding="0"
                                    FontAttributes="Bold"/>

                            <Button Text="Save"
                                    WidthRequest="130"
                                    HeightRequest="50"
                                    BackgroundColor="#D4A574"
                                    TextColor="White"
                                    Command="{Binding SaveProductCommand}"
                                    CornerRadius="20"
                                    FontSize="15"
                                    Padding="0"
                                    FontAttributes="Bold"
                                    IsVisible="{Binding IsEditMode}"/>

                            <Button Text="Next"
                                    WidthRequest="130"
                                    HeightRequest="50"
                                    BackgroundColor="#5B4F45"
                                    TextColor="White"
                                    Command="{Binding OpenConnectPOSToInventoryCommand}"
                                    CornerRadius="20"
                                    FontSize="15"
                                    Padding="0"
                                    FontAttributes="Bold"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Grid>
        </Frame>
        
    </AbsoluteLayout>
</ContentView>
