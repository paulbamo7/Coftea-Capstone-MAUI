<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui" 
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml" 
             x:Class="Coftea_Capstone.Views.Pages.SalesReport" 
             xmlns:vm="clr-namespace:Coftea_Capstone.ViewModel" 
             xmlns:views="clr-namespace:Coftea_Capstone.Views.Pages"
             xmlns:charts="clr-namespace:Coftea_Capstone.Views.Controls"
             xmlns:otherViews="clr-namespace:Coftea_Capstone.Views.Controls" 
             xmlns:converters="clr-namespace:Coftea_Capstone.ViewModel.Others"
             Shell.TabBarIsVisible="False" 
             BackgroundColor="#C1A892">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertBoolConverter x:Key="InvertBoolConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*">
        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="SidebarColumn" Width="200" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Sidebar Navigation -->
        <views:NavigationBar x:Name="Sidebar" Grid.Column="0" />

        <!-- Main Content -->
        <ScrollView Grid.Column="1">
            <VerticalStackLayout Padding="20" Spacing="16">

                <!-- Top Bar -->
                <Grid ColumnDefinitions="*,Auto,Auto" Padding="0,10" VerticalOptions="Center" ColumnSpacing="16">
                    <Label Text="" Grid.Column="0" TextColor="Black"/>

                    <ImageButton Grid.Column="1" Source="notification.png" WidthRequest="35" HeightRequest="35" BackgroundColor="Transparent" Clicked="OnBellClicked"/>
                    <ImageButton Source="usericon.png" Grid.Column="2" WidthRequest="40" HeightRequest="40" CornerRadius="20"/>
                </Grid>

                <!-- Categories - Centered above pie chart and KPI cards -->
                <ScrollView Orientation="Horizontal" HorizontalOptions="Center">
                    <HorizontalStackLayout Spacing="10">
                        <Button Text="Overview" FontAttributes="Bold" TextColor="Black" FontSize="14"
                                BackgroundColor="#FFEAD6" WidthRequest="120" HeightRequest="40"
                                Command="{Binding SelectCategoryCommand}" CommandParameter="Overview">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Overview">
                                    <Setter Property="BackgroundColor" Value="#EBCFBF" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                        <Button Text="Frappe" FontAttributes="Bold" TextColor="Black" FontSize="14"
                                BackgroundColor="#FFEAD6" WidthRequest="120" HeightRequest="40"
                                Command="{Binding SelectCategoryCommand}" CommandParameter="Frappe">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Frappe">
                                    <Setter Property="BackgroundColor" Value="#EBCFBF" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                        <Button Text="Fruit/Soda" FontAttributes="Bold" TextColor="Black" FontSize="14"
                                BackgroundColor="#FFEAD6" WidthRequest="120" HeightRequest="40"
                                Command="{Binding SelectCategoryCommand}" CommandParameter="Fruit/Soda">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Fruit/Soda">
                                    <Setter Property="BackgroundColor" Value="#FFE0C4" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                        <Button Text="Milktea" FontAttributes="Bold" TextColor="Black" FontSize="14"
                                BackgroundColor="#FFEAD6" WidthRequest="120" HeightRequest="40"
                                Command="{Binding SelectCategoryCommand}" CommandParameter="Milktea">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Milktea">
                                    <Setter Property="BackgroundColor" Value="#F4E1D2" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                        <Button Text="Coffee" FontAttributes="Bold" TextColor="Black" FontSize="14"
                                BackgroundColor="#FFEAD6" WidthRequest="120" HeightRequest="40"
                                Command="{Binding SelectCategoryCommand}" CommandParameter="Coffee">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding SelectedCategory}" Value="Coffee">
                                    <Setter Property="BackgroundColor" Value="#E3C2A6" />
                                    <Setter Property="TextColor" Value="#2b2b2b" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                    </HorizontalStackLayout>
                </ScrollView>

                <!-- KPI Cards and Pie Chart - Responsive wrap -->
                <FlexLayout Direction="Row" Wrap="Wrap" JustifyContent="SpaceBetween" AlignItems="Start" AlignContent="Start" Margin="0,0,0,0">
                    <!-- KPI Cards -->
                    <VerticalStackLayout Spacing="12"  VerticalOptions="Start" WidthRequest="515">
                        <Frame BackgroundColor="#F5E6D8" CornerRadius="12"  HeightRequest="110" Padding="12" HasShadow="True">
                            <VerticalStackLayout>
                                <Label Text="Overall Most Bought Today" FontAttributes="Bold" FontSize="14" TextColor="#5B4F45"/>
                                <Label Text="{Binding MostBoughtToday}" FontSize="20" TextColor="#5B4F45"/>
                            </VerticalStackLayout>
                        </Frame>

                        <Frame BackgroundColor="#F5E6D8" CornerRadius="12" HeightRequest="110" Padding="12" HasShadow="True">
                            <VerticalStackLayout>
                                <Label Text="Trending Today" FontAttributes="Bold" FontSize="14" TextColor="#5B4F45"/>
                                <Grid ColumnDefinitions="Auto,Auto" ColumnSpacing="4">
                                    <Label Text="{Binding TrendingToday}" FontSize="20" TextColor="#5B4F45"/>
                                    <Label Text="{Binding TrendingPercentage, StringFormat='{0:+0%;-0%;0%}'}" FontSize="16" TextColor="Green" Grid.Column="1"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Frame>
                    </VerticalStackLayout>

                    <!-- Top 3 Picks Today - Pie Chart -->
                    <Frame BackgroundColor="White" CornerRadius="12" Padding="12" HasShadow="True" WidthRequest="515" HeightRequest="230" HorizontalOptions="End">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                            <Label Text="Top 3 Picks Today" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45"/>
                            <Label Text="{Binding FilteredTodayOrders, StringFormat='{0} Orders'}" Grid.Column="1" FontSize="14" TextColor="Gray"/>
                            <otherViews:SimplePieChart Grid.Row="1" Grid.ColumnSpan="2" ItemsSource="{Binding TopItemsToday}" 
                                                      Item1Name="{Binding Item1Name}" 
                                                      Item2Name="{Binding Item2Name}" 
                                                      Item3Name="{Binding Item3Name}"
                                                      Item1Count="{Binding Item1Count}"
                                                      Item2Count="{Binding Item2Count}"
                                                      Item3Count="{Binding Item3Count}"
                                                      Item1HasTrend="{Binding Item1HasTrend}"
                                                      Item2HasTrend="{Binding Item2HasTrend}"
                                                      Item3HasTrend="{Binding Item3HasTrend}"/>
                        </Grid>
                    </Frame>
                </FlexLayout>

                <!-- Weekly and Monthly Picks - Two-column layout -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <!-- Weekly Picks -->
                    <Frame BackgroundColor="White" CornerRadius="12" Padding="12" HasShadow="True">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                            <Label Text="Weekly Picks" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45"/>
                            <Label Text="{Binding FilteredWeeklyOrders, StringFormat='{0} Orders'}" Grid.Column="1" FontSize="14" TextColor="Gray"/>
                            <!-- Bar chart for Weekly items -->
                            <CollectionView Grid.Row="1" Grid.ColumnSpan="2" ItemsSource="{Binding TopItemsWeekly}" HeightRequest="180" ItemsLayout="HorizontalList">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <VerticalStackLayout HorizontalOptions="Center" WidthRequest="90" VerticalOptions="End" Spacing="6">
                                            <Grid HeightRequest="150" VerticalOptions="End" RowDefinitions="*,Auto">
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>
                                                    <BoxView VerticalOptions="End" HeightRequest="{Binding ScaledCount}" WidthRequest="45" Color="#9C27B0" CornerRadius="8"/>
                                                </Grid>
                                                <Label Grid.Row="1" Text="{Binding Name}" FontSize="10" LineBreakMode="TailTruncation" HorizontalTextAlignment="Center"/>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                            <CollectionView ItemsSource="{Binding TopItemsWeekly}" HeightRequest="100" Grid.Row="2" Grid.ColumnSpan="2">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding Name}" FontSize="12"/>
                                            <Label Text="{Binding Count, StringFormat='{0} sold'}" FontSize="12" TextColor="Gray" Grid.Column="1"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </Frame>

                    <!-- Monthly Picks -->
                    <Frame BackgroundColor="White" CornerRadius="12" Padding="12" HasShadow="True" Grid.Column="1">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                            <Label Text="Monthly Picks" FontAttributes="Bold" FontSize="18" TextColor="#5B4F45"/>
                            <Label Text="{Binding MonthlyOrders, StringFormat='{0} Orders'}" Grid.Column="1" FontSize="14" TextColor="Gray"/>
                            <!-- Bar chart for Monthly items -->
                            <CollectionView Grid.Row="1" Grid.ColumnSpan="2" ItemsSource="{Binding TopItemsMonthly}" HeightRequest="180" ItemsLayout="HorizontalList">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <VerticalStackLayout HorizontalOptions="Center" WidthRequest="90" VerticalOptions="End" Spacing="6">
                                            <Grid HeightRequest="150" VerticalOptions="End" RowDefinitions="*,Auto">
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>
                                                    <BoxView VerticalOptions="End" HeightRequest="{Binding ScaledCount}" WidthRequest="45" Color="#FF9800" CornerRadius="8"/>
                                                </Grid>
                                                <Label Grid.Row="1" Text="{Binding Name}" FontSize="10" LineBreakMode="TailTruncation" HorizontalTextAlignment="Center"/>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                            <CollectionView ItemsSource="{Binding TopItemsMonthly}" HeightRequest="100" Grid.Row="2" Grid.ColumnSpan="2">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding Name}" FontSize="12"/>
                                            <Label Text="{Binding Count, StringFormat='{0} sold'}" FontSize="12" TextColor="Gray" Grid.Column="1"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </Frame>
                </Grid>

                
            </VerticalStackLayout>
        </ScrollView>

        <!-- Settings Popup (shared) -->
        <views:Settings BindingContext="{Binding Source={x:Static Application.Current}, Path=SettingsPopup}" Grid.ColumnSpan="2"/>

        <!-- Manage POS Options Popup -->
        <otherViews:ManagePOSOptions BindingContext="{Binding Source={x:Static Application.Current}, Path=ManagePOSPopup}" Grid.ColumnSpan="2"/>
        <otherViews:EditProductPopup BindingContext="{Binding Source={x:Static Application.Current}, Path=ManagePOSPopup.EditProductPopupVM}" Grid.ColumnSpan="2"/>

        <!-- Manage Inventory Options Popup -->
        <otherViews:ManageInventoryOptions BindingContext="{Binding Source={x:Static Application.Current}, Path=ManageInventoryPopup}" Grid.ColumnSpan="2"/>
        <otherViews:AddItemToInventory BindingContext="{Binding Source={x:Static Application.Current}, Path=ManageInventoryPopup.AddItemToInventoryVM}" Grid.ColumnSpan="2"/>
        <otherViews:AddItemToPOS BindingContext="{Binding Source={x:Static Application.Current}, Path=AddItemPopup}" Grid.ColumnSpan="2"/>

        <!-- Retry Connection Popup -->
        <otherViews:RetryConnectionPopup x:Name="RetryConnectionPopup" Grid.ColumnSpan="2"/>

        <!-- Notification Popup Overlay -->
        <otherViews:NotificationPopup BindingContext="{Binding Source={x:Static Application.Current}, Path=NotificationPopup}" Grid.ColumnSpan="2" ZIndex="1500"/>
    </Grid>
</ContentPage>
